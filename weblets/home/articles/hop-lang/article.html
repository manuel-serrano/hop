<!-- 95% W3C COMPLIANT, 95% CSS FREE, RAW HTML -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
<title>Hop, a Language for Programming the Web 2.0</title>
 <style type="text/css">
  <!--
  pre { font-family: monospace }
  tt { font-family: monospace }
  code { font-family: monospace }
  p.flushright { text-align: right }
  p.flushleft { text-align: left }
  span.sc { font-variant: small-caps }
  span.sf { font-family: sans-serif }
  span.skribetitle { font-family: sans-serif; font-weight: bolder; font-size: x-large; }
  span.refscreen { }
  span.refprint { display: none; }
/*=====================================================================*/
/*    serrano/diffusion/article/hop-lang/css/article.css               */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Fri Jun 10 09:15:18 2005                          */
/*    Last change :  Thu Dec  1 14:31:27 2005 (serrano)                */
/*    Copyright   :  2005 Manuel Serrano                               */
/*    -------------------------------------------------------------    */
/*    Mail Article CSS                                                 */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    Default settings                                                 */
/*---------------------------------------------------------------------*/
body {
  display: block;
  width: 45em;
  margin: auto;
  font-family: PostAntiqua;
}

p {
  text-align: justify;
}

ul {
  text-align: justify;
}

ol {
  text-align: justify;
}

div.section {
  margin-bottom: 1em;
}

div.abstract {
  margin: 1em;
  padding: 1px 10px 1px 10px;
  background: #eef;
  font-size: medium;
  font-family: Trebuchet ms;
  font-style: italic;
  border: 1px dotted black;
}

div.footnote {
  font-size: small;
}

div.skribesectiontitle {
  padding-top: 0;
  padding-bottom: 0em;
  margin-top: 0;
  margin-bottom: 1em;
}

div.section-atitle h3 {
  border-top: thin solid black;
  border-bottom: thin solid black;
  padding-top: 0;
  padding-bottom: 0;
  margin-top: 0;
  margin-bottom: 15px;
}

div.document-title {
  font-family: PostAntiqua;
}

div.document-title-title {
  text-align: right;
  font-weight: bold;
  font-size: 30pt;
  border-top: thin solid black;
  border-bottom: medium solid black;
  margin-top: 1em;
  margin-bottom: 1em;
  margin-top: 10px;
  padding-top: 10px;

}

div.document-title-authors {
  margin-bottom: 2em;
}

span.document-author {
  display: block;
  text-align: right;
  margin-bottom: 1em;
}

span.document-author span {
  font-style: italic;
}

span.document-author span.document-author-name {
  font-weight: bold;
  font-size: large;
  font-style: normal;
  display: block;
}

span.document-author span.document-author-url {
  font-style: normal;
  display: block;
}

span.document-author span.document-author-email {
  font-style: normal;
  display: block;
}

div.prog-border {
  border: 1px solid #aaa;
}

pre.scheme {
  background-color: #ffffee;
  border: thin dashed black;
  padding: 2pt;
  font-style: normal;
}

pre.uscheme {
  background-color: #eeffee;
  border: thin dashed black;
  padding: 2pt;
  font-style: normal;
}

pre.repl {
  background-color: #eff;
  border: thin dashed black;
  padding: 2pt;
  font-style: normal;
}

pre.c {
  background-color: #eeffff;
  border: thin solid black;
  padding: 2pt;
  font-style: normal;
}

pre.display {
  background-color: #ffeeee;
  border: thin solid black;
  padding: 2pt;
  font-style: normal;
}

center.show {
  background-color: #ffeeff;
  border: thin solid black;
  padding: 2pt;
  margin: 0;
  font-style: normal;
  text-align: left;
}

center.show ul {
  padding: 2pt;
  padding-left: 14pt;
  margin: 0;
}

div.references table {
  font-size: small;
}

div.references table td {
  font-size: small;
}

div.references table th {
  font-size: small;
}

table.api-table {
  border: none;
  background-color: #ffe;
}

tr.api-table-prototype {
   background-color: #ffc;
}

tr.api-table-header {
   background-color: #fcf;
}

div.section#appendix p {
   margin-left: 5%;
}

div.plan {
  border: 1px dotted red;
  margin-left: 10px;
  margin-right: 10px;
  padding: 5px;
  color: #d00;
  font-family: sans-serif;
  font-style: italic;
  font-size: small;
  background: #eee;
}

/*---------------------------------------------------------------------*/
/*    prgm ...                                                         */
/*---------------------------------------------------------------------*/
pre {
  padding-left: 2px;
  margin: 0;
}

pre.bigloo {
  background-color: #dff;
}

pre.lhtml {
  background-color: #fdf;
}

pre.hop {
  background-color: #ffc;
}

pre.html {
  background-color: #ccf;
}

pre.server {
  background-color: #eee;
  color: #007;
}

pre.client {
  background-color: #eee;
  color: #033;
}

pre.syntax {
  background-color: #dfd;
}

/*---------------------------------------------------------------------*/
/*    Printing configuration                                           */
/*---------------------------------------------------------------------*/
@media print {
/*--- Markup configuration --------------------------------------------*/
pre {
  font-size: 8pt;
  font-family: courier;
  line-height: 95%;
}

div.prog-border {
  border: 0;
}

pre.prog {
  font-size: 6pt;
  line-height: 100%;
}

center.break-page-before {
  page-break-before: always;
}

table.api-table {
  border: 1px solid black;
  padding: 10px;
}

table.api-table tr.api td {
  padding-top: 5px;
}

table.api-table th {
  padding-left: 5px;
  padding-right: 5px;
}

table.api-table td {
  padding-left: 5px;
  padding-right: 5px;
}

.api-table-prototype {
  display: none;
}

.api-table-header {
  display: none;
}

span.refscreen {
  display: none;
}

span.refprint {
  display: inline;
}

div.abstract {
  border: none;
  line-height: 100%;
}

div.section#Table-of-contents {
  display: none;
}

div.section#Postscript-download {
  display: none;
}

span.document-author span.document-author-name {
  font-size: 13pt;
  font-family: sans-serif;
  font-weight: normal;
}

a {
  text-decoration: none;
}

pre.scheme {
  background-color: #ffffee;
  border: none;
}

pre.uscheme {
  background-color: #eeffee;
  border: none;
}

pre.repl {
  background-color: #eff;
  border: none;
}

div.skribe-ending {
  display: none;
}

div.print-plan {
  display: none;
}

div.section-atitle h3 {
  border-top: 0;
  border-bottom: 0;
}
}
/*=====================================================================*/
/*    serrano/diffusion/article/hop-lang/css/sigplan.css               */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu Dec  1 11:00:10 2005                          */
/*    Last change :  Wed Dec 14 13:46:49 2005 (serrano)                */
/*    Copyright   :  2005 Manuel Serrano                               */
/*    -------------------------------------------------------------    */
/*    The SIGPLAN CSS                                                  */
/*=====================================================================*/

@media print {
  div.document-title {
    font-family: Palatino;
/*     -moz-column-count: 1;                                           */
    width: 100%;
    text-align: center;
  }

  div.document-title-title {
/*     width: 42pc;                                                    */
    font-weight: bold;
    font-size: 20pt;
    text-align: center;
    line-height: 120%;
    border: 0;
  }

  div.document-title-authors {
    display: table;
/*     width: 42pc;                                                    */
    text-align: center;
    margin-bottom: 1.8cm;
  }

  div.document-authors {
    width: 100%;
    display: table-row;
    text-align: center;
  }

  span.document-author {
    text-align: center;
    display: table-cell;
    width: 50%;
  }

  span.document-author span.document-author-name {
    font-size: large;
    font-family: Palatino;
    padding-bottom: 0.5em;
  }

  span.document-author span.document-author-affiliation {
    font-style: normal;
  }

  span.document-author tt {
    font-family: mono, sans-serif;
    font-size: 8pt;
  }

  div.skribe-body {
/*     -moz-column-count: 2;                                           */
/*     -moz-column-rule: none;                                         */
/*     -moz-column-gap: 2pc;                                           */
/*     width: 42pc;                                                    */
  }
 
  body, div.abstract {
    font-size: 9pt;
    line-height: 110%;
    font-family: Palatino;
    font-style: normal;
    padding: 0;
    margin-top: 1in;
    margin-left: .70in;
    margin-right: .70in;
    margin-bottom: 1in;
  }

  div.abstract {
    font-size: 9pt;
    line-height: 110%;
    font-family: Palatino;
    font-style: normal;
    padding: 0;
    margin-top: 1in;
/*     margin-left: .70in;                                             */
/*     margin-right: .70in;                                            */
  }

  div.abstract {
    margin: 0;
  }

  div.section#References {
/*     font-size: x-small;                                             */
  }
  
  div.section#References table {
    font-size: inherit;
  }

  @page { 
    size: 8.5in 11in; 
    margin-bottom: 5cm;
  }
}
  -->
 </style>
</head>

<body class="document">
<div id="Hop-a-Language-for-Programming-the-Web-2.0-title" class="document-title">
<div id="Hop-a-Language-for-Programming-the-Web-2.0-title" class="document-title-title">
Hop, a Language for Programming the Web 2.0</div>
<div id="Hop-a-Language-for-Programming-the-Web-2.0-title" class="document-title-authors">
<div class="document-authors">
<span id="author1655" class="document-author">
<span class="document-author-name" id="author1655">Manuel Serrano</span>
<span class="document-author-affiliation" id="author1655">Inria Sophia Antipolis</span>
<span class="document-author-email" id="author1655"><a href="http://www.inria.fr/mimosa/Manuel.Serrano" class="http"><tt id='tt1654'
>http://www.inria.fr/mimosa/Manuel.Serrano</tt></a></span>
</span
<span id="author1657" class="document-author">
<span class="document-author-name" id="author1657">Erick Gallesio</span>
<span class="document-author-affiliation" id="author1657">Université de Nice Inria Sophia Antipolis</span>
<span class="document-author-email" id="author1657"><a href="http://www.essi.fr/~eg" class="http"><tt id='tt1656'
>http://www.essi.fr/~eg</tt></a></span>
</span
<span id="author1659" class="document-author">
<span class="document-author-name" id="author1659">Florian Loitsch</span>
<span class="document-author-affiliation" id="author1659">Inria Sophia Antipolis</span>
<span class="document-author-email" id="author1659"><a href="http://www.inria.fr/mimosa/Florian.Loitsch" class="http"><tt id='tt1658'
>http://www.inria.fr/mimosa/Florian.Loitsch</tt></a></span>
</span
</div></div>
</div>
<div class="skribe-body">
<div class="section" id="Abstract"><!-- Abstract -->
<a name="Abstract"></a>
<div class="abstract-atitle"><h3><font color="black">Abstract</font>
</h3></div><div class="abstract">
<p id='paragraph1660'
>Hop is a new higher-order language designed for programming
interactive web applications such as web agendas, web galleries, music
players, etc. It exposes a programming model based on two computation
levels. The first one is in charge of executing the logic of an
application while the second one is in charge of executing the
graphical user interface. Hop separates the logic and the graphical
user interface but it packages them together and it supports strong
collaboration between the two engines. The two execution flows
communicate through function calls and event loops. Both ends
can initiate communications.</p><p id='paragraph1661'
>The paper presents the main constructions of Hop. It sketches
its implementation and it presents an example of a simple web
application written in Hop.</p></div><br>
</div>
<div class="section" id="Table-of-contents"><!-- Table of contents -->
<a name="Table-of-contents"></a>
<div class="section-atitle"><h3><font color="black">Table of contents</font>
</h3></div><div class="section">
<table cellspacing="1" cellpadding="1" width="100%" class="toc">
<tbody>
 <tr><td valign="top" align="left"></td><td colspan="4" width="100%"><a href="article.html#Download">Download</a></td></tr>
 <tr><td valign="top" align="left">1</td><td colspan="4" width="100%"><a href="article.html#Introduction">Introduction</a></td></tr>
 <tr><td></td><td valign="top" align="left">1.1</td><td colspan="3" width="100%"><a href="article.html#The-HOP-programming-language">The HOP programming language</a></td></tr>
 <tr><td></td><td valign="top" align="left">1.2</td><td colspan="3" width="100%"><a href="article.html#Overview-of-the-paper">Overview of the paper</a></td></tr>
 <tr><td valign="top" align="left">2</td><td colspan="4" width="100%"><a href="article.html#Overall-language-design">Overall language design</a></td></tr>
 <tr><td></td><td valign="top" align="left">2.1</td><td colspan="3" width="100%"><a href="article.html#Rationale">Rationale</a></td></tr>
 <tr><td></td><td valign="top" align="left">2.2</td><td colspan="3" width="100%"><a href="article.html#A-dual-core-execution">A dual core execution</a></td></tr>
 <tr><td></td><td valign="top" align="left">2.3</td><td colspan="3" width="100%"><a href="article.html#A-dual-language">A dual language</a></td></tr>
 <tr><td></td><td valign="top" align="left">2.4</td><td colspan="3" width="100%"><a href="article.html#Objectives">Objectives</a></td></tr>
 <tr><td valign="top" align="left">3</td><td colspan="4" width="100%"><a href="article.html#The-HOP-syntax">The HOP syntax</a></td></tr>
 <tr><td></td><td valign="top" align="left">3.1</td><td colspan="3" width="100%"><a href="article.html#The-syntax-of-the-main-stratum">The syntax of the main stratum</a></td></tr>
 <tr><td></td><td valign="top" align="left">3.2</td><td colspan="3" width="100%"><a href="article.html#The-syntax-of-the-GUI-stratum">The syntax of the GUI stratum</a></td></tr>
 <tr><td valign="top" align="left">4</td><td colspan="4" width="100%"><a href="article.html#The-HOP-dual-evaluation">The HOP dual evaluation</a></td></tr>
 <tr><td></td><td valign="top" align="left">4.1</td><td colspan="3" width="100%"><a href="article.html#Dual-Execution">Dual Execution</a></td></tr>
 <tr><td></td><td valign="top" align="left">4.2</td><td colspan="3" width="100%"><a href="article.html#The-Elaboration-time">The Elaboration time</a></td></tr>
 <tr><td></td><td valign="top" align="left">4.3</td><td colspan="3" width="100%"><a href="article.html#HOP-services">HOP services</a></td></tr>
 <tr><td></td><td valign="top" align="left">4.4</td><td colspan="3" width="100%"><a href="article.html#HOP-Event-loops">HOP Event loops</a></td></tr>
 <tr><td valign="top" align="left">5</td><td colspan="4" width="100%"><a href="article.html#Example">Example</a></td></tr>
 <tr><td valign="top" align="left">6</td><td colspan="4" width="100%"><a href="article.html#Implementation">Implementation</a></td></tr>
 <tr><td></td><td valign="top" align="left">6.1</td><td colspan="3" width="100%"><a href="article.html#Implementation-of-Services">Implementation of Services</a></td></tr>
 <tr><td></td><td valign="top" align="left">6.2</td><td colspan="3" width="100%"><a href="article.html#Implementation-of-Events">Implementation of Events</a></td></tr>
 <tr><td valign="top" align="left">7</td><td colspan="4" width="100%"><a href="article.html#Discussion-and-Related-work">Discussion and Related work</a></td></tr>
 <tr><td></td><td valign="top" align="left">7.1</td><td colspan="3" width="100%"><a href="article.html#Related-work">Related work</a></td></tr>
 <tr><td valign="top" align="left">8</td><td colspan="4" width="100%"><a href="article.html#Conclusion">Conclusion</a></td></tr>
 <tr><td valign="top" align="left">9</td><td colspan="4" width="100%"><a href="article.html#References">References</a></td></tr>
 <tr><td valign="top" align="left"></td><td colspan="4" width="100%"><a href="article.html#Appendix">Appendix</a></td></tr>
</tbody>
</table>
</div><br>
</div>
<div class="section" id="Download"><!-- Download -->
<a name="Download"></a>
<div class="section-atitle"><h3><font color="black">Download</font>
</h3></div><div class="section">
Hop is available at: 
<a href="http://hop.inria.fr" class="http"><tt id='tt1663'
>http://hop.inria.fr</tt></a>. <p id='paragraph1664'
></p><p id='paragraph1665'
>The web site contains the distribution of the source code, the
online documentation, and various demonstrations.</p></div><br>
</div>
<div class="section" id="Introduction"><!-- Introduction -->
<a name="Introduction"></a>
<div class="section-atitle"><h3><font color="black">1 Introduction</font>
</h3></div><div class="section">
<p id='paragraph1667'
>The recent evolution of the web makes it suitable for replacing
traditional graphical user interfaces (henceforth GUIs). The
combination of fast HTML rendering of modern web browsers (such as
Gecko 20051111, shipped with Firefox 1.5), generalized
support of CSS2 [<a href="article.html#w3c:css2" class="inbound">15</a>], yet expected to be rapidly
supplanted by CSS3, and the recent adoption of asynchronous
transactions (aka Ajax, the acronym of <em id='emph1666'
>Asynchronous JavaScript
and XML</em>), makes web applications nearly as fancy and reactive as
traditional GUIs. Some famous applications such as Google/mail,
Google/map, or Zimbra's mailer demonstrate that web applications have
bridged the gap with traditional GUIs.</p><p id='paragraph1669'
>In addition to allowing reactive and graphically pleasing
interfaces, web applications are <em id='emph1668'
>de facto</em> distributed.
Implementing an application with a web interface makes it instantly
open to the world and accessible from much more than one computer. The
web also partially solves the problem of platform compatibility
because it physically separates the rendering engine from the
computation engine. Therefore, the client does not have to make
assumption on the server hardware configuration, and vice
versa. Lastly, HTML is highly durable. While traditional graphical
toolkits evolve continuously, obsoleting existing interfaces and
breaking backward compatibility, modern web browsers that render on
the edge web pages are still able to correctly display the web pages
of the early 1990's.</p><p id='paragraph1670'
>For these reasons, the web is arguably ready to escape the
beaten track of n-tiers applications, CGI scripting and interaction
based on HTML forms. However, we think that it still lacks programming
abstractions that minimize the overwhelming amount of technologies that
need to be mastered when web programming is involved. As a step in this
direction, we propose Hop, a higher order language aimed at programming
interactive web applications. It is built on top of HTML, CSS, and
JavaScript that are considered, in this work, as assembly languages.</p><!-- The HOP programming language -->
<a name="The-HOP-programming-language"></a>
<div class="subsection-atitle"><h3>1.1 The HOP programming language</h3></div><div class="subsection">
<p id='paragraph1672'
>Hop is mainly designed for programming small- to medium-
sized <em id='emph1671'
>interactive applications</em> across the web. It is
designed as a general-purpose web programming language which targets
applications such as electronic agendas, photographs
browsers, music players, mailer clients, operating system
administration tools, and so on. In addition to enabling programming
distributed applications over the web, Hop is also convenient for
implementing applications that run on a single computer, on behalf of
a single user. In that particular case, Hop is considered as a replacement
for traditional graphical toolkits.</p><p id='paragraph1673'
>In contrast with most web-oriented languages and frameworks
such as PHP and Ruby On Rails, the design of Hop is not
database-centric. That is, while its standard library provides APIs
for managing databases, Hop is not specially tuned for programming
applications that access databases via the web. Hop is designed for
programming various kinds of applications that need graphical user
interfaces amongst which some might access databases.</p><p id='paragraph1674'
>Hop follows the path opened by Tcl/Tk, Java/Swing, or
C/GTK+ but it differs from its ancestors by enforcing a strict
separation between the programming of the interface from the
programming of the logic of the applications. For that, it exposes a
dual core execution model where one core executes the computations
needed by the logic of the program while the second core executes the
computations needed by the graphical interface. We have deliberately
provided Hop with a stratified language approach in order to
emphasize the duality of these programs. However Hop tightly links the 
code of the interface and the code of
the logic:</p><ul class="itemize" id='itemize1678'
><li>it packages a whole application in a single location 
             (e.g. a file).</li>
<li>it supports function calls that traverse the strata.</li>
<li>it supports data exchange between the strata.</li>
</ul><p id='paragraph1679'
>Hop helps programming web applications because:</p><ul class="itemize" id='itemize1686'
><li>it eases the deployment of applications by hiding URLs
and by packaging the components of an application in a single
place.</li>
<li>it simplifies the control flow of the web application by allowing
symmetric communications that can be initiated by both ends.</li>
<li>it supports efficient event loops that avoid busy waiting.</li>
<li>it eases the communication between servers and clients
by supporting transparent function calls and partially shared name spaces.</li>
<li>it provides a library of pre-defined widgets.</li>
<li>it allows users to implement their own set of widgets
that can be combined with the standard library for implementing complex
GUIs.</li>
</ul></div>
<!-- Overview of the paper -->
<a name="Overview-of-the-paper"></a>
<div class="subsection-atitle"><h3>1.2 Overview of the paper</h3></div><div class="subsection">
<p id='paragraph1687'
>The paper is organized as follows. Section <a href="article.html#Overall-language-design" class="inbound"><span class="refscreen">Overall language design</span><span class="refprint">2</span></a> informally presents the stratified
language design. Section <a href="article.html#The-HOP-syntax" class="inbound"><span class="refscreen">The HOP syntax</span><span class="refprint">3</span></a> presents
its syntax. The following Section <a href="article.html#The-HOP-dual-evaluation" class="inbound"><span class="refscreen">The HOP dual evaluation</span><span class="refprint">4</span></a> presents
its semantics. It zooms in the function calls, and it presents
the Hop's event loop. Section <a href="article.html#Example" class="inbound"><span class="refscreen">Example</span><span class="refprint">5</span></a> presents
an example of Hop programming. It shows a simplistic IMAP web client. 
Section <a href="article.html#Implementation" class="inbound"><span class="refscreen">Implementation</span><span class="refprint">6</span></a> sketches the current
implementation of Hop. Section <a href="article.html#Discussion-and-Related-work" class="inbound"><span class="refscreen">Discussion and Related work</span><span class="refprint">7</span></a> presents
related work and envisions future work.</p></div>
</div><br>
</div>
<div class="section" id="Overall-language-design"><!-- Overall language design -->
<a name="Overall-language-design"></a>
<div class="section-atitle"><h3><font color="black">2 Overall language design</font>
</h3></div><div class="section">
<p id='paragraph1688'
>In this section, we present the rationale of Hop. We
informally present its execution model and its syntax.  
This section only gives the intuition of what programming
with Hop means. The technical presentations are left for Sections
<a href="article.html#The-HOP-syntax" class="inbound"><span class="refscreen">The HOP syntax</span><span class="refprint">3</span></a> and <a href="article.html#The-HOP-dual-evaluation" class="inbound"><span class="refscreen">The HOP dual evaluation</span><span class="refprint">4</span></a>.</p><!-- Rationale -->
<a name="Rationale"></a>
<div class="subsection-atitle"><h3>2.1 Rationale</h3></div><div class="subsection">
<p id='paragraph1692'
>Hop fosters a model where the <em id='emph1689'
>main</em> computation of
an application is executed on a <em id='emph1690'
>server</em> and the graphical
user interface is executed on remote <em id='emph1691'
>clients</em>. From the user
point of view, a Hop program is executed within a web browser and
it is associated with a well known URL. Once the program starts, the
server and the clients continuously communicate. The exchanges are
implemented by remote function calls and event loops. Hop is well
suited for implementing applications that need frequent communications
between the server and the client. For instance, we have implemented a
music player with Hop that continuously displays, on the client, the
elapsed time of the songs played on the server. On that particular
application, as with many others we have implemented with Hop, 
the server and the client are frequently hosted by the same physical
computer.</p></div>
<!-- A dual core execution -->
<a name="A-dual-core-execution"></a>
<div class="subsection-atitle"><h3>2.2 A dual core execution</h3></div><div class="subsection">
<p id='paragraph1695'
>A Hop program is executed simultaneously on several engines.
The <em id='emph1693'
>main</em> engine is dedicated to executing the logic of the
program.  It executes CPU demanding computations and operations that
require system privileges for accessing files or other resources.  The
other engines, henceforth called <em id='emph1694'
>GUI engines</em>, are dedicated to
executing actions related to the programming of the graphical user
interfaces. Engines are mapped to actual physical computers. More than one 
engine can be mapped to a single computer.</p><p id='paragraph1699'
>When a Hop program starts, it first executes on the main
engine. This elaborates the description of a graphical user interface
that is sent to a GUI engine. From that moment, the execution flows
from the GUI engine to the main engine and vice versa. The GUI engines
may invoke <em id='emph1696'
>services</em> from the main engine by the means of
function calls. The main engine may <em id='emph1697'
>signal</em> events to the GUI
engines. Each event carries an identity and a value. Events are
handled asynchronously. They are used by the main engine to notify GUI
engines when a new information is available. They are a means for
implementing <em id='emph1698'
>pushing</em> on the web.</p></div>
<!-- A dual language -->
<a name="A-dual-language"></a>
<div class="subsection-atitle"><h3>2.3 A dual language</h3></div><div class="subsection">
<p id='paragraph1702'
>Hop is a <em id='emph1700'
>stratified</em> language. The first stratum is 
dedicated to programming the <em id='emph1701'
>main</em> engines, or the servers. The 
second stratum is  dedicated to programming graphical user interfaces, or
the clients.</p><p id='paragraph1703'
>Both strata provide different facilities. On the one hand, the
main stratum provides an API for accessing the file system and the
other resources of the computer that hosts it, but it does not
support any facility for handling graphical user interfaces. On the
other hand, the GUI strata is provided with a full set of
functionalities for dealing with graphical interactions but it has
drastically restricted accesses to the resources of the computer it
executes on. Because they are using different APIs, in general,
an expression of the main stratum cannot be executed on the client
and vice versa.</p></div>
<!-- Objectives -->
<a name="Objectives"></a>
<div class="subsection-atitle"><h3>2.4 Objectives</h3></div><div class="subsection">
<p id='paragraph1704'
>As presented in Section <a href="article.html#The-HOP-syntax" class="inbound"><span class="refscreen">The HOP syntax</span><span class="refprint">3</span></a>, Hop uses a compact syntax that is close to the syntax used in
traditional XML authoring. However, it is a complete programming language that
subsumes many web technologies. As such, it allows the implementation of
libraries that can be combined for implementing complex
applications.</p><p id='paragraph1705'
>For the sake of the example and to give an intuition of
what Hop programming looks like, here is a complete Hop program:</p><pre id='pre1706'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog1719'
>(<strong id='bold2407'
>let</strong> ((def (<font color="#1919af"><strong id='bold2408'
>&lt;DIV&gt;</strong></font> <font color="red">&quot;&quot;</font>))
      (svc (<strong id='bold2411'
>service</strong> (w)
              (<font color="#1919af"><strong id='bold2412'
>&lt;P&gt;</strong></font> (sql-exec db <font color="red">&quot;SELECT * FROM dict WHERE (def=~a)&quot;</font> w)))))
   (<font color="#1919af"><strong id='bold2415'
>&lt;HTML&gt;</strong></font>
      (<font color="#1919af"><strong id='bold2417'
>&lt;BODY&gt;</strong></font>
         (<font color="#1919af"><strong id='bold2419'
>&lt;TABLE&gt;</strong></font>
            (<font color="#1919af"><strong id='bold2421'
>&lt;TR&gt;</strong></font>
               (<font color="#1919af"><strong id='bold2423'
>&lt;TD&gt;</strong></font> <font color="red">&quot;search&quot;</font>)
               (<font color="#1919af"><strong id='bold2426'
>&lt;TD&gt;</strong></font> (<font color="#1919af"><strong id='bold2428'
>&lt;INPUT&gt;</strong></font>
                        <strong id='bold2430'
>:type</strong> <font color="red">&quot;text&quot;</font>
                        <strong id='bold2433'
>:onkeyup</strong> <font color="red"><strong id='bold2435'
>~</strong></font>(<font color="red"><strong id='bold2437'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold2439'
>$svc</strong></font> this.value)
                                     (<strong id='bold2441'
>lambda</strong> (h)
                                        (<strong id='bold2442'
>set!</strong> <font color="#00cf00"><strong id='bold2443'
>$def.innerHTML</strong></font> h))))))
            (<font color="#1919af"><strong id='bold2445'
>&lt;TR&gt;</strong></font>
               (<font color="#1919af"><strong id='bold2447'
>&lt;TD&gt;</strong></font> <strong id='bold2449'
>:colspan</strong> 2 def))))))
                  
</pre>
</DIV><pre id='pre1720'
></pre>
<p id='paragraph1723'
>This program acts similarly to Google/suggest. The client
displays an input box. It interactively reacts to key press
events. Each time a new character is entered, the client invokes a
service on the server which searches in a database the definition of the
word sent by the client. On success, the definition is displayed back
in the client display. The most important part of this example is the
<font color="blue"><tt id='tt1721'
>with-hop</tt></font> construction that invokes, from the client, a function 
located on the server. It is detailed in Section <a href="article.html#HOP-services" class="inbound"><span class="refscreen">HOP services</span><span class="refprint">4.3</span></a></p></div>
</div><br>
</div>
<div class="section" id="The-HOP-syntax"><!-- The HOP syntax -->
<a name="The-HOP-syntax"></a>
<div class="section-atitle"><h3><font color="black">3 The HOP syntax</font>
</h3></div><div class="section">
<p id='paragraph1724'
>This section presents the syntax of Hop. It first presents
the syntax of the main stratum. Then, it presents the escape syntactic
construction that switches to the GUI stratum. The formal definition of 
the syntax is given in the Appendix.</p><!-- The syntax of the main stratum -->
<a name="The-syntax-of-the-main-stratum"></a>
<div class="subsection-atitle"><h3>3.1 The syntax of the main stratum</h3></div><div class="subsection">
<p id='paragraph1726'
>At first glance, the syntax of the main stratum of Hop is a
mere variation around HTML involving superficial modifications.
It merely introduces an extra open parenthesis before any
markup and replaces the closing markup with the single closing
parenthesis. It also encloses string literals within <tt id='tt1725'
>&quot;</tt> characters.
Therefore, the HTML expression:</p><pre id='pre1727'
></pre>
<DIV class='prog-border'><pre class="html" id='prog1728'
><font color="#1919af"><strong id='bold2451'
>&lt;HTML</strong></font><font color="#1919af"><strong id='bold2453'
>&gt;</strong></font>
   <font color="#1919af"><strong id='bold2455'
>&lt;BODY</strong></font><font color="#1919af"><strong id='bold2457'
>&gt;</strong></font>
      <font color="#1919af"><strong id='bold2459'
>&lt;B</strong></font><font color="#1919af"><strong id='bold2461'
>&gt;</strong></font>A plain text<font color="#1919af"><strong id='bold2463'
>&lt;/B</strong></font><font color="#1919af"><strong id='bold2465'
>&gt;</strong></font>
   <font color="#1919af"><strong id='bold2467'
>&lt;/BODY</strong></font><font color="#1919af"><strong id='bold2469'
>&gt;</strong></font>
<font color="#1919af"><strong id='bold2471'
>&lt;/HTML</strong></font><font color="#1919af"><strong id='bold2473'
>&gt;</strong></font>
</pre>
</DIV><pre id='pre1729'
></pre>
<p id='paragraph1730'
>is written in Hop, as:</p><pre id='pre1731'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog1733'
>(<font color="#1919af"><strong id='bold2475'
>&lt;HTML&gt;</strong></font>
   (<font color="#1919af"><strong id='bold2477'
>&lt;BODY&gt;</strong></font>
      (<font color="#1919af"><strong id='bold2479'
>&lt;B&gt;</strong></font> <font color="red">&quot;A plain text&quot;</font>)))
</pre>
</DIV><pre id='pre1734'
></pre>
<p id='paragraph1736'
>In Hop, attributes are introduced by an identifier starting
with a colon character (<tt id='tt1735'
>:</tt>) and their value is separated from
the name by white spaces. Hence the corresponding Hop program of the HTML
document of Figure <a href="article.html#A-simple-HTML-file." class="inbound">1</a> is written as in Figure
<a href="article.html#A-simple-HOP-program." class="inbound">2</a>.</p><br class="figure" id='A simple HTML file.'
><a name="A-simple-HTML-file."></a>
<DIV class='prog-border'><pre class="html" id='prog1737'
><font color="#1919af"><strong id='bold2482'
>&lt;HTML</strong></font><font color="#1919af"><strong id='bold2484'
>&gt;</strong></font>
   <font color="#1919af"><strong id='bold2486'
>&lt;BODY</strong></font><font color="#1919af"><strong id='bold2488'
>&gt;</strong></font>
      <font color="#1919af"><strong id='bold2490'
>&lt;TABLE</strong></font> width=<font color="red">&quot;100%&quot;</font><font color="#1919af"><strong id='bold2493'
>&gt;</strong></font>
         <font color="#1919af"><strong id='bold2495'
>&lt;TR</strong></font><font color="#1919af"><strong id='bold2497'
>&gt;</strong></font> <font color="#1919af"><strong id='bold2499'
>&lt;TD</strong></font><font color="#1919af"><strong id='bold2501'
>&gt;</strong></font>0<font color="#1919af"><strong id='bold2503'
>&lt;/TD</strong></font><font color="#1919af"><strong id='bold2505'
>&gt;</strong></font><font color="#1919af"><strong id='bold2507'
>&lt;/TR</strong></font><font color="#1919af"><strong id='bold2509'
>&gt;</strong></font>
         <font color="#1919af"><strong id='bold2511'
>&lt;TR</strong></font><font color="#1919af"><strong id='bold2513'
>&gt;</strong></font> <font color="#1919af"><strong id='bold2515'
>&lt;TD</strong></font><font color="#1919af"><strong id='bold2517'
>&gt;</strong></font>1<font color="#1919af"><strong id='bold2519'
>&lt;/TD</strong></font><font color="#1919af"><strong id='bold2521'
>&gt;</strong></font><font color="#1919af"><strong id='bold2523'
>&lt;/TR</strong></font><font color="#1919af"><strong id='bold2525'
>&gt;</strong></font>
         <font color="#1919af"><strong id='bold2527'
>&lt;TR</strong></font><font color="#1919af"><strong id='bold2529'
>&gt;</strong></font> <font color="#1919af"><strong id='bold2531'
>&lt;TD</strong></font><font color="#1919af"><strong id='bold2533'
>&gt;</strong></font>2<font color="#1919af"><strong id='bold2535'
>&lt;/TD</strong></font><font color="#1919af"><strong id='bold2537'
>&gt;</strong></font><font color="#1919af"><strong id='bold2539'
>&lt;/TR</strong></font><font color="#1919af"><strong id='bold2541'
>&gt;</strong></font>
         <font color="#1919af"><strong id='bold2543'
>&lt;TR</strong></font><font color="#1919af"><strong id='bold2545'
>&gt;</strong></font> <font color="#1919af"><strong id='bold2547'
>&lt;TD</strong></font><font color="#1919af"><strong id='bold2549'
>&gt;</strong></font>3<font color="#1919af"><strong id='bold2551'
>&lt;/TD</strong></font><font color="#1919af"><strong id='bold2553'
>&gt;</strong></font><font color="#1919af"><strong id='bold2555'
>&lt;/TR</strong></font><font color="#1919af"><strong id='bold2557'
>&gt;</strong></font>
      <font color="#1919af"><strong id='bold2559'
>&lt;/TABLE</strong></font><font color="#1919af"><strong id='bold2561'
>&gt;</strong></font>
   <font color="#1919af"><strong id='bold2563'
>&lt;/BODY</strong></font><font color="#1919af"><strong id='bold2565'
>&gt;</strong></font>
<font color="#1919af"><strong id='bold2567'
>&lt;/HTML</strong></font><font color="#1919af"><strong id='bold2569'
>&gt;</strong></font>
</pre>
</DIV><br>
<center><small><strong>Fig. 1:</strong> A simple HTML file.</small></center><br><p id='paragraph1738'
>In spite of the strong resemblance, there is a very important
difference between the semantics of the two sources. While the
HTML source can be interpreted as the external representation of a
tree, the Hop source is actually a computer program that can be
evaluated in order to produce a document. This is detailed in 
Section <a href="article.html#The-HOP-dual-evaluation" class="inbound"><span class="refscreen">The HOP dual evaluation</span><span class="refprint">4</span></a>.</p><br class="figure" id='A simple HOP program.'
><a name="A-simple-HOP-program."></a>
<DIV class='prog-border'><pre class="hop" id='prog1741'
>(<font color="#1919af"><strong id='bold2571'
>&lt;HTML&gt;</strong></font>
   (<font color="#1919af"><strong id='bold2573'
>&lt;BODY&gt;</strong></font>
      (<font color="#1919af"><strong id='bold2575'
>&lt;TABLE&gt;</strong></font> <strong id='bold2577'
>:width</strong> <font color="red">&quot;100%&quot;</font>
         (<font color="#1919af"><strong id='bold2580'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2582'
>&lt;TD&gt;</strong></font> 0))
         (<font color="#1919af"><strong id='bold2584'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2586'
>&lt;TD&gt;</strong></font> 1))
         (<font color="#1919af"><strong id='bold2588'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2590'
>&lt;TD&gt;</strong></font> 2))
         (<font color="#1919af"><strong id='bold2592'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2594'
>&lt;TD&gt;</strong></font> 3)))))
</pre>
</DIV><br>
<center><small><strong>Fig. 2:</strong> A simple HOP program.</small></center><br></div>
<!-- The syntax of the GUI stratum -->
<a name="The-syntax-of-the-GUI-stratum"></a>
<div class="subsection-atitle"><h3>3.2 The syntax of the GUI stratum</h3></div><div class="subsection">
<p id='paragraph1746'
>The GUI stratum is composed of <em id='emph1742'
>GUI
expressions</em>. They are nested inside <em id='emph1743'
>main
expressions</em>. The "<font color="blue"><tt id='tt1744'
>~</tt></font>" character escapes from main
expressions to GUI expressions. The GUI expressions are usually
used as values of attributes, as can be seen in the following example:</p><pre id='pre1747'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog1750'
>(<font color="#1919af"><strong id='bold2596'
>&lt;HTML&gt;</strong></font>
   (<font color="#1919af"><strong id='bold2598'
>&lt;BODY&gt;</strong></font>
      (<font color="#1919af"><strong id='bold2600'
>&lt;BUTTON&gt;</strong></font>
         <strong id='bold2602'
>:onclick</strong> <font color="red"><strong id='bold2604'
>~</strong></font>(alert (* (Math.atan 1) 4))
         <font color="red">&quot;Click me to see an approximation of PI&quot;</font>)))
</pre>
</DIV><pre id='pre1751'
></pre>
<p id='paragraph1756'
>The character "<font color="blue"><tt id='tt1752'
>$</tt></font>" escapes from the GUI stratum back to
the main stratum. That is, it introduces an expression of the main
stratum inside an expression of the GUI stratum. There is no limit to
the nesting level so these main stratum expressions may, in turn, use
the "<font color="blue"><tt id='tt1754'
>~</tt></font>" character to escape back to the GUI
stratum. For the sake of the example, let us consider a re-writing of
the previous example where the approximation of &#960; is moved
to the main stratum:</p><pre id='pre1757'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog1760'
>(<font color="#1919af"><strong id='bold2607'
>&lt;HTML&gt;</strong></font>
   (<font color="#1919af"><strong id='bold2609'
>&lt;BODY&gt;</strong></font>
      (<font color="#1919af"><strong id='bold2611'
>&lt;BUTTON&gt;</strong></font>
         <strong id='bold2613'
>:onclick</strong> <font color="red"><strong id='bold2615'
>~</strong></font>(alert <font color="#00cf00"><strong id='bold2617'
>$</strong></font>(* 4 (atan 1)))
         <font color="red">&quot;Click me to see an approximation of PI&quot;</font>)))
</pre>
</DIV><pre id='pre1761'
></pre>
<p id='paragraph1762'
>Note that these two programs are likely to show different
approximations since no provision is taken to guarantee that the
precision of the arithmetic of the main stratum and the precision of
the GUI stratum are the same.</p></div>
</div><br>
</div>
<div class="section" id="The-HOP-dual-evaluation"><!-- The HOP dual evaluation -->
<a name="The-HOP-dual-evaluation"></a>
<div class="section-atitle"><h3><font color="black">4 The HOP dual evaluation</font>
</h3></div><div class="section">
<p id='paragraph1765'
>Hop brings abstraction to HTML. While HTML is a mere
syntax that carries no semantics, Hop is a programming language.
While a HTML expression denotes a <em id='emph1763'
>tree</em>, a Hop
expression is evaluated in order to produce a <em id='emph1764'
>value</em>. While
HTML markups are syntactic elements, in Hop, they are
functions. More precisely, the meaning of the Hop expression:</p><DIV class='prog-border'><pre class="hop" id='prog1773'
>   (<em id='it1766'
>fun</em> <em id='it1769'
>a<sub id='sub1768'
><font size="-3">0</font></sub></em> <em id='it1772'
>a<sub id='sub1771'
><font size="-3">1</font></sub></em>...)
</pre>
</DIV>is the application of the function <font color="blue"><tt id='tt1775'
><em id='it1774'
>fun</em></tt></font>
to the arguments <font color="blue"><tt id='tt1780'
><em id='it1779'
>a<sub id='sub1778'
><font size="-3">0</font></sub></em></tt></font>, <font color="blue"><tt id='tt1785'
><em id='it1784'
>a<sub id='sub1783'
><font size="-3">1</font></sub></em></tt></font>. Provided with 
this semantics, we can reconsider the previous Hop expression:<DIV class='prog-border'><pre class="hop" id='prog1788'
>   (<font color="#1919af"><strong id='bold2620'
>&lt;B&gt;</strong></font> <font color="red">&quot;A plain text&quot;</font>)
</pre>
</DIV><p id='paragraph1803'
>This expression is actually the call of the function
<font color="blue"><tt id='tt1789'
>&lt;B&gt;</tt></font> with the literal string <font color="blue"><tt id='tt1791'
>&quot;A plain text&quot;</tt></font> as
argument. It should be noted that Hop identifiers may use more
characters than most programming languages. In particular, the
characters <font color="blue"><tt id='tt1793'
>&lt;</tt></font> and <font color="blue"><tt id='tt1795'
>&gt;</tt></font> are legal identifiers
characters, as letters, digits, <font color="blue"><tt id='tt1797'
>_</tt></font>, <font color="blue"><tt id='tt1799'
>?</tt></font>, <font color="blue"><tt id='tt1801'
>!</tt></font>,
and many others (see the Appendix).</p><p id='paragraph1804'
>Hop is unsurprisingly based on the Scheme algorithmic
programming language [<a href="article.html#scheme:r5rs" class="inbound">9</a>] for which familiarity
is assumed in the rest of this paper. Hop extends Scheme in
many directions. It supports object-oriented programming, exceptions,
modules, and multi-threading. It comes with various tools and libraries such
as tools for constructing parsers and libraries for programming
networks, multimedia applications, and so on. In addition to these
features traditionally offered by programming languages, Hop
supports original constructions specially designed for programming web
applications. Since this paper focuses on web programming, it is
intentionally shallow on the constructions that are not strictly related
to this topic.</p><p id='paragraph1805'
>In the rest of this section, we present the Hop evaluation model.
First, in Section <a href="article.html#Dual-Execution" class="inbound"><span class="refscreen">Dual Execution</span><span class="refprint">4.1</span></a>
we present how a program is spawned. Then, in Section
<a href="article.html#The-Elaboration-time" class="inbound"><span class="refscreen">The Elaboration time</span><span class="refprint">4.2</span></a>, we present how GUI expressions are
built. Then, the Section <a href="article.html#HOP-services" class="inbound"><span class="refscreen">HOP services</span><span class="refprint">4.3</span></a> constitutes
the heart of this paper. It presents how the two strata collaborate.</p><!-- Dual Execution -->
<a name="Dual-Execution"></a>
<div class="subsection-atitle"><h3>4.1 Dual Execution</h3></div><div class="subsection">
<p id='paragraph1807'
>The execution of a Hop program differs from the execution of
traditional computer programs. In order to be executed, a Hop
program has to be first loaded on a <em id='emph1806'
>HOP server</em>. This server
conforms to the HTTP protocol [<a href="article.html#rfc:http" class="inbound">4</a>]. It binds
the program to an URL provided by the administrator of the
server. This URL is used by clients (i.e. web browsers) to start the
program.</p><p id='paragraph1809'
>A Hop program constructs a <em id='emph1808'
>response</em> to an HTTP
request. In general, this response is a XML document but in some
situations it can be any other data structures. For the sake of
simplicity, in this paper, we focus on HTML responses only but all
the presented techniques also directly apply to XML.</p><p id='paragraph1812'
>The execution of a Hop program is distributed. One part is
executed on the <em id='emph1810'
>server</em> which evaluates the expressions of
the main stratum. The second part is executed on the <em id='emph1811'
>client</em>
which evaluates the expressions of the GUI stratum. In general the
execution flow switches from a server to a client and vice versa but
Hop also allows two (or more) execution flows to run in parallel.
The client communicates with the server via remote function calls.
The server communicates with the client via signals. Both communication
means allow compound values to be carried.</p></div>
<!-- The Elaboration time -->
<a name="The-Elaboration-time"></a>
<div class="subsection-atitle"><h3>4.2 The Elaboration time</h3></div><div class="subsection">
<p id='paragraph1814'
>The purpose of most Hop programs is to build HTML pages that
are visualized by web browsers. The phase of the execution on the
server where the HTML pages are constructed is called <em id='emph1813'
>elaboration</em>. It takes place before any execution can start
on the client.</p><p id='paragraph1815'
>Hop implements HTML pages as trees. The Hop libraries of
the two strata provide functions for constructing and manipulating
them. In both strata, the trees are first class values. Hence,
they can be passed as argument to functions, returned as
results, and stored into data structures and variables. For the sake of
the example, Figure <a href="article.html#Using-variables-in-HOP-programs." class="inbound">3</a>
is a re-writing of the Hop program presented
Figure <a href="article.html#A-simple-HOP-program." class="inbound">2</a> where the four rows of
the table are bound to local variables.</p><br class="figure" id='Using variables in HOP programs.'
><a name="Using-variables-in-HOP-programs."></a>
<DIV class='prog-border'><pre class="hop" id='prog1819'
>(<strong id='bold2623'
>let</strong> ((row0 (<font color="#1919af"><strong id='bold2624'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2626'
>&lt;TD&gt;</strong></font> 0)))
      (row1 (<font color="#1919af"><strong id='bold2628'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2630'
>&lt;TD&gt;</strong></font> 1)))
      (row2 (<font color="#1919af"><strong id='bold2632'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2634'
>&lt;TD&gt;</strong></font> 2)))
      (row3 (<font color="#1919af"><strong id='bold2636'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2638'
>&lt;TD&gt;</strong></font> 3))))
   (<font color="#1919af"><strong id='bold2640'
>&lt;HTML&gt;</strong></font>
      (<strong id='bold2642'
>let</strong> ((table (<font color="#1919af"><strong id='bold2643'
>&lt;TABLE&gt;</strong></font> row0 row1 row2 row3)))
         (<font color="#1919af"><strong id='bold2645'
>&lt;BODY&gt;</strong></font> table))))
</pre>
</DIV><br>
<center><small><strong>Fig. 3:</strong> Using variables in HOP programs.</small></center><br><p id='paragraph1820'
>The interest of such an approach is better understood when some
abstraction is used. In the example of Figure 
<a href="article.html#Using-HOP-naming-conventions." class="inbound">4</a> a function is defined for
automating the construction of the rows of the table.</p><br class="figure" id='Using HOP naming conventions.'
><a name="Using-HOP-naming-conventions."></a>
<DIV class='prog-border'><pre class="hop" id='prog1823'
>(<font color="#6959cf"><strong id='bold2647'
>define</strong></font> (<font color="#1919af"><strong id='bold2649'
>&lt;ROW&gt;</strong></font> v<font color="#6959cf"><strong id='bold2651'
>)</strong></font>
   (<font color="#1919af"><strong id='bold2653'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold2655'
>&lt;TD&gt;</strong></font> v)))

(<font color="#1919af"><strong id='bold2657'
>&lt;HTML&gt;</strong></font>
   (<strong id='bold2659'
>let</strong> ((table (<font color="#1919af"><strong id='bold2660'
>&lt;TABLE&gt;</strong></font> (<font color="#1919af"><strong id='bold2662'
>&lt;ROW&gt;</strong></font> 0) (<font color="#1919af"><strong id='bold2664'
>&lt;ROW&gt;</strong></font> 1) (<font color="#1919af"><strong id='bold2666'
>&lt;ROW&gt;</strong></font> 2) (<font color="#1919af"><strong id='bold2668'
>&lt;ROW&gt;</strong></font> 3))))
      (<font color="#1919af"><strong id='bold2670'
>&lt;BODY&gt;</strong></font> table)))
</pre>
</DIV><br>
<center><small><strong>Fig. 4:</strong> Using HOP naming conventions.</small></center><br><p id='paragraph1828'
>Note that the Hop convention is to surround the name of the
functions that build HTML trees by the <font color="blue"><tt id='tt1824'
>&lt;</tt></font> and <font color="blue"><tt id='tt1826'
>&gt;</tt></font>
characters and to use upper case letters. This example implicitly
unveils that Hop standard HTML markups are implemented as regular
functions. It also shows that defining a new markup in a user program
is no more complex than defining a function.</p><p id='paragraph1831'
>As presented in Section <a href="article.html#The-syntax-of-the-GUI-stratum" class="inbound"><span class="refscreen">The syntax of the GUI stratum</span><span class="refprint">3.2</span></a>, any
expression of the main stratum can be nested in an expression of the GUI
stratum after an escaping <font color="blue"><tt id='tt1829'
>$</tt></font> character. At elaboration time,
the escaping main stratum expressions are evaluated and the resulting
values are injected in the response. In consequence, when the
response is shipped to the client it is totally stripped of main
stratum expressions. Let's consider the Hop source of
Figure <a href="article.html#A-program-before-elaboration." class="inbound">5</a> before elaboration.</p><br class="figure" id='A program before elaboration.'
><a name="A-program-before-elaboration."></a>
<DIV class='prog-border'><pre class="hop" id='prog1843'
><em id='it2672'
> 1: </em><a name="1" class="mark"></a>(<font color="#6959cf"><strong id='bold2673'
>define</strong></font> x <font color="red">&quot;out&quot;</font><font color="#6959cf"><strong id='bold2676'
>)</strong></font> 
<em id='it2678'
> 2: </em><a name="2" class="mark"></a>(<font color="#6959cf"><strong id='bold2679'
>define</strong></font> y (vector 1 2 3<font color="#6959cf"><strong id='bold2681'
>)</strong></font>) 
<em id='it2683'
> 3: </em>
<em id='it2684'
> 4: </em>(<font color="#1919af"><strong id='bold2685'
>&lt;HTML&gt;</strong></font>
<em id='it2687'
> 5: </em>   (<font color="#1919af"><strong id='bold2688'
>&lt;BODY&gt;</strong></font>
<em id='it2690'
> 6: </em><a name="6" class="mark"></a>      (<font color="#1919af"><strong id='bold2691'
>&lt;SCRIPT&gt;</strong></font> <font color="red"><strong id='bold2693'
>~</strong></font>(<font color="#6959cf"><strong id='bold2695'
>define</strong></font> x 0<font color="#6959cf"><strong id='bold2697'
>)</strong></font>) 
<em id='it2699'
> 7: </em>      (<font color="#1919af"><strong id='bold2700'
>&lt;P&gt;</strong></font> <strong id='bold2702'
>:onmouseover</strong> <font color="red"><strong id='bold2704'
>~</strong></font>(<strong id='bold2706'
>begin</strong>
<em id='it2707'
> 8: </em>                            (<strong id='bold2708'
>set!</strong> x (+ 1 x))
<em id='it2709'
> 9: </em><a name="9" class="mark"></a>                            (alert <font color="red">&quot;over=&quot;</font> x)) 
<em id='it2711'
>10: </em><a name="10" class="mark"></a>           <strong id='bold2712'
>:onmouseout</strong> (alert <font color="#00cf00"><strong id='bold2714'
>$x</strong></font>) 
<em id='it2716'
>11: </em><a name="11" class="mark"></a>           <strong id='bold2717'
>:onclick</strong> (alert <font color="#00cf00"><strong id='bold2719'
>$y</strong></font>) 
<em id='it2721'
>12: </em>           <font color="red">&quot;foo&quot;</font>)))
</pre>
</DIV><br>
<center><small><strong>Fig. 5:</strong> A program before elaboration.</small></center><br><p id='paragraph1854'
>Reflecting the two different execution times, the two strata use
separate name spaces. A variable from the main stratum and a
variable from the GUI stratum can hence hold the same name without
conflicting. In other words, the variables defined line <em id='it1844'
><i id='line-ref'
><a href="article.html#1" class="inbound">1</a></i></em>
and line <em id='it1845'
><i id='line-ref'
><a href="article.html#6" class="inbound">6</a></i></em> of Figure <a href="article.html#A-program-before-elaboration." class="inbound">5</a> are
different. The elaboration phase replaces the occurrences of the
variable <font color="blue"><tt id='tt1846'
>x</tt></font> that belongs to the main stratum line <em id='it1848'
><i id='line-ref'
><a href="article.html#10" class="inbound">10</a></i></em> with the value <font color="blue"><tt id='tt1849'
>&quot;out&quot;</tt></font> but it leaves
the variable <font color="blue"><tt id='tt1851'
>x</tt></font> that belongs to the GUI stratum line <em id='it1853'
><i id='line-ref'
><a href="article.html#9" class="inbound">9</a></i></em> as shown in Figure <a href="article.html#The-program-after-elaboration." class="inbound">6</a>.</p><br class="figure" id='The program after elaboration.'
><a name="The-program-after-elaboration."></a>
<DIV class='prog-border'><pre class="hop" id='prog1864'
><em id='it2723'
> 4: </em>(<font color="#1919af"><strong id='bold2724'
>&lt;HTML&gt;</strong></font>
<em id='it2726'
> 5: </em>   (<font color="#1919af"><strong id='bold2727'
>&lt;BODY&gt;</strong></font>
<em id='it2729'
> 6: </em>      (<font color="#1919af"><strong id='bold2730'
>&lt;SCRIPT&gt;</strong></font> <font color="red"><strong id='bold2732'
>~</strong></font>(<font color="#6959cf"><strong id='bold2734'
>define</strong></font> x 0<font color="#6959cf"><strong id='bold2736'
>)</strong></font>)
<em id='it2738'
> 7: </em>      (<font color="#1919af"><strong id='bold2739'
>&lt;P&gt;</strong></font> <strong id='bold2741'
>:onmouseover</strong> <font color="red"><strong id='bold2743'
>~</strong></font>(<strong id='bold2745'
>begin</strong>
<em id='it2746'
> 8: </em>                            (<strong id='bold2747'
>set!</strong> x (+ 1 x))
<em id='it2748'
> 9: </em>                            (alert <font color="red">&quot;over=&quot;</font> x))
<em id='it2750'
>10: </em>           <strong id='bold2751'
>:onmouseout</strong> <font color="red"><strong id='bold2753'
>~</strong></font>(alert <font color="red">&quot;out&quot;</font>)
<em id='it2756'
>11: </em>           <strong id='bold2757'
>:onclick</strong> <font color="red"><strong id='bold2759'
>~</strong></font>(alert '#(1 2 3))
<em id='it2761'
>12: </em>           <font color="red">&quot;foo&quot;</font>)))
</pre>
</DIV><br>
<center><small><strong>Fig. 6:</strong> The program after elaboration.</small></center><br><p id='paragraph1872'
>As it can be seen here, the variable <font color="blue"><tt id='tt1865'
>y</tt></font> which is bound to
a Hop vector in Figure <a href="article.html#A-program-before-elaboration." class="inbound">5</a>, line <em id='it1867'
><i id='line-ref'
><a href="article.html#2" class="inbound">2</a></i></em> is replaced with a constant vector in Figure <a href="article.html#The-program-after-elaboration." class="inbound">6</a>, line <em id='it1868'
><i id='line-ref'
><a href="article.html#11" class="inbound">11</a></i></em>. This shows that the elaboration can
inject complex data structures in the response. In particular
it can inject tree branches that are under construction. This is 
illustrated by the next example that shows that an HTML tree can be used when
constructing a document in the main Hop program (line <em id='it1869'
><i id='line-ref'
><a href="article.html#5" class="inbound">5</a></i></em> of
Figure <a href="article.html#Injecting-a-tree-branch." class="inbound">7</a>) <em id='emph1870'
>and</em> can also be
injected in the GUI stratum (line <em id='it1871'
><i id='line-ref'
><a href="article.html#7" class="inbound">7</a></i></em>). The following example
constructs an HTML page that swaps the two items of the unordered list
each time the button is clicked.</p><br class="figure" id='Injecting a tree branch.'
><a name="Injecting-a-tree-branch."></a>
<DIV class='prog-border'><pre class="hop" id='prog1879'
><em id='it2763'
> 1: </em>(<strong id='bold2764'
>let</strong> ((el (<font color="#1919af"><strong id='bold2765'
>&lt;UL&gt;</strong></font> (<font color="#1919af"><strong id='bold2767'
>&lt;LI&gt;</strong></font> <font color="red">&quot;foo&quot;</font>) (<font color="#1919af"><strong id='bold2770'
>&lt;LI&gt;</strong></font> <font color="red">&quot;bar&quot;</font>))))
<em id='it2773'
> 2: </em>   (<font color="#1919af"><strong id='bold2774'
>&lt;HTML&gt;</strong></font>
<em id='it2776'
> 3: </em>      (<font color="#1919af"><strong id='bold2777'
>&lt;HOP-HEAD&gt;</strong></font>)
<em id='it2779'
> 4: </em>      (<font color="#1919af"><strong id='bold2780'
>&lt;BODY&gt;</strong></font>
<em id='it2782'
> 5: </em><a name="5" class="mark"></a>         el
<em id='it2783'
> 6: </em>         (<font color="#1919af"><strong id='bold2784'
>&lt;BUTTON&gt;</strong></font>
<em id='it2786'
> 7: </em><a name="7" class="mark"></a>            <strong id='bold2787'
>:onclick</strong> <font color="red"><strong id='bold2789'
>~</strong></font>(<strong id='bold2791'
>let*</strong> ((nodes (dom-child-nodes <font color="#00cf00"><strong id='bold2792'
>$el</strong></font>))
<em id='it2794'
> 8: </em>                             (a (array-ref nodes 0))
<em id='it2795'
> 9: </em>                             (b (array-ref nodes 1)))
<em id='it2796'
>10: </em>                         (dom-append-child! <font color="#00cf00"><strong id='bold2797'
>$el</strong></font> (dom-replaceChild a b)))
<em id='it2799'
>11: </em>            <font color="red">&quot;swap me&quot;</font>))))
</pre>
</DIV><br>
<center><small><strong>Fig. 7:</strong> Injecting a tree branch.</small></center><br></div>
<!-- HOP services -->
<a name="HOP-services"></a>
<div class="subsection-atitle"><h3>4.3 HOP services</h3></div><div class="subsection">
<p id='paragraph1880'
>This section presents one of the main technical novelty
brought by Hop, namely the Hop remote services.</p><!-- HOP service definition -->
<a name="HOP-service-definition"></a>
<div class="subsubsection-atitle"><h4>4.3.1 HOP service definition</h4></div><div class="subsubsection">
<p id='paragraph1881'
>HTML's URLs play a role similar to functions in
programming languages. Let us consider the following HTML page (for
simplicity, expressed in the Hop syntax):</p><DIV class='prog-border'><pre class="hop" id='prog1899'
>(<font color="#1919af"><strong id='bold2801'
>&lt;HTML&gt;</strong></font>
   <font color="darkmagenta"><em id='it2803'
>;; a link to google portal</em></font>
   (<font color="#1919af"><strong id='bold2805'
>&lt;A&gt;</strong></font> <strong id='bold2807'
>:href</strong> <font color="red">&quot;http://www.google.com&quot;</font> <font color="red">&quot;Google Portal&quot;</font>)
   <font color="darkmagenta"><em id='it2811'
>;; a google request</em></font>
   (<font color="#1919af"><strong id='bold2813'
>&lt;FORM&gt;</strong></font> <strong id='bold2815'
>:action</strong> <font color="red">&quot;http://www.google.com/search&quot;</font>
           (<font color="#1919af"><strong id='bold2818'
>&lt;INPUT&gt;</strong></font> <strong id='bold2820'
>:type</strong> <font color="red">&quot;text&quot;</font> <strong id='bold2823'
>:name</strong> <font color="red">&quot;q&quot;</font> <strong id='bold2826'
>:value</strong> <font color="red">&quot;&quot;</font>)
           (<font color="#1919af"><strong id='bold2829'
>&lt;INPUT&gt;</strong></font> <strong id='bold2831'
>:type</strong> <font color="red">&quot;submit&quot;</font> <strong id='bold2834'
>:name</strong> <font color="red">&quot;btnG&quot;</font> <strong id='bold2837'
>:value</strong> <font color="red">&quot;search&quot;</font>)))
</pre>
</DIV><p id='paragraph1903'
>In a plain HTML document, the URL <tt id='tt1900'
>http://www.google.com</tt> 
could be considered as a function named <font color="blue"><tt id='tt1901'
>www.google.com</tt></font> whose 
signature is: </p><DIV class='prog-border'><pre class="hop" id='prog1904'
>   unit &#8594; HTMLtree
</pre>
</DIV><p id='paragraph1911'
>It is called when a user clicks on the hyper link implemented by
the <font color="blue"><tt id='tt1905'
>&lt;A&gt;</tt></font> markup. Similarly, the URL <tt id='tt1907'
>http://www.google.com/search</tt> denotes another function. It is
called when the user clicks the <tt id='tt1908'
>submit</tt> button. This one accepts
a parameter named <font color="blue"><tt id='tt1909'
>q</tt></font> and its signature is hence:</p><DIV class='prog-border'><pre class="hop" id='prog1912'
>   string &#8594; HTMLtree
</pre>
</DIV><p id='paragraph1916'
>Hop transparently binds URLs to special functions called
<em id='emph1913'
>services</em>. These reside on the server and
they are called from the clients. They are defined by the form <font color="blue"><tt id='tt1914'
>define-service</tt></font> whose syntax is:</p><pre id='pre1917'
></pre>
<DIV class='prog-border'><pre class="server" id='prog1924'
>   (define-service (<em id='it1918'
>&lt;ident&gt;</em> <em id='it1919'
>&lt;ident&gt;</em><sub id='sub1922'
><small><small><em id='it1920'
>0</em></small></small></sub> ...)
      <em id='it1923'
>&lt;expression&gt;</em>)
</pre>
</DIV><pre id='pre1925'
></pre>
<p id='paragraph1939'
><font color="blue"><tt id='tt1927'
><em id='it1926'
>&lt;Ident&gt;</em></tt></font> is the name of the service and 
<font color="blue"><tt id='tt1933'
><em id='it1929'
>&lt;ident&gt;</em><sub id='sub1932'
><small><small><small><em id='it1930'
>0</em></small></small></small></sub></tt></font>, ... are 
its parameters. The form <font color="blue"><tt id='tt1935'
>define-service</tt></font> is similar to the Scheme
function definition form <font color="blue"><tt id='tt1937'
>define</tt></font> but in addition to binding a function
to an identifier in the server, it also binds it to an URL that
can be used to run a Hop program. Let us consider the following example 
which is a complete Hop program:</p><br class="figure" id='A complete HOP program defining two services.'
><a name="A-complete-HOP-program-defining-two-services."></a>
<DIV class='prog-border'><pre class="hop" id='prog1958'
><em id='it2840'
> 1: </em><a name="1" class="mark"></a>(<font color="#6959cf"><strong id='bold2841'
>define-service</strong></font> (portal<font color="#6959cf"><strong id='bold2843'
>)</strong></font> 
<em id='it2845'
> 2: </em>   <font color="darkmagenta"><em id='it2846'
>;; produce a web page containing a big lambda character</em></font>
<em id='it2848'
> 3: </em>   (<font color="#1919af"><strong id='bold2849'
>&lt;HTML&gt;</strong></font>
<em id='it2851'
> 4: </em>      (<font color="#1919af"><strong id='bold2852'
>&lt;BODY&gt;</strong></font>
<em id='it2854'
> 5: </em>         (<font color="#1919af"><strong id='bold2855'
>&lt;CENTER&gt;</strong></font> (<font color="#1919af"><strong id='bold2857'
>&lt;B&gt;</strong></font> (<font color="#1919af"><strong id='bold2859'
>&lt;BIG&gt;</strong></font> (<font color="#1919af"><strong id='bold2861'
>&lt;BIG&gt;</strong></font> (<font color="#1919af"><strong id='bold2863'
>&lt;BIG&gt;</strong></font> (<font color="#1919af"><strong id='bold2865'
>&lt;BIG&gt;</strong></font> <font color="red">&quot;&amp;#955;&quot;</font>)))))))))
<em id='it2868'
> 6: </em>
<em id='it2869'
> 7: </em><a name="7" class="mark"></a>(<font color="#6959cf"><strong id='bold2870'
>define-service</strong></font> (rev q<font color="#6959cf"><strong id='bold2872'
>)</strong></font> 
<em id='it2874'
> 8: </em>   <font color="darkmagenta"><em id='it2875'
>;; produce a web page made of the reverse of the argument</em></font>
<em id='it2877'
> 9: </em>   (<font color="#1919af"><strong id='bold2878'
>&lt;HTML&gt;</strong></font>
<em id='it2880'
>10: </em>      (<font color="#1919af"><strong id='bold2881'
>&lt;BODY&gt;</strong></font>
<em id='it2883'
>11: </em>         (<font color="#1919af"><strong id='bold2884'
>&lt;CENTER&gt;</strong></font> (<font color="#1919af"><strong id='bold2886'
>&lt;B&gt;</strong></font> (list-&gt;string (reverse (string-&gt;list q))))))))
<em id='it2888'
>12: </em>
<em id='it2889'
>13: </em><a name="13" class="mark"></a>(<font color="#1919af"><strong id='bold2890'
>&lt;HTML&gt;</strong></font> 
<em id='it2892'
>14: </em>   <font color="darkmagenta"><em id='it2893'
>;; a link to our Hop portal</em></font>
<em id='it2895'
>15: </em><a name="15" class="mark"></a>   (<font color="#1919af"><strong id='bold2896'
>&lt;A&gt;</strong></font> <strong id='bold2898'
>:href</strong> portal <font color="red">&quot;portal&quot;</font>) 
<em id='it2901'
>16: </em>   <font color="darkmagenta"><em id='it2902'
>;; a HOP request</em></font>
<em id='it2904'
>17: </em><a name="17" class="mark"></a>   (<font color="#1919af"><strong id='bold2905'
>&lt;FORM&gt;</strong></font> <strong id='bold2907'
>:action</strong> rev 
<em id='it2909'
>18: </em>           (<font color="#1919af"><strong id='bold2910'
>&lt;INPUT&gt;</strong></font> <strong id='bold2912'
>:type</strong> <font color="red">&quot;text&quot;</font> <strong id='bold2915'
>:name</strong> <font color="red">&quot;q&quot;</font> <strong id='bold2918'
>:value</strong> <font color="red">&quot;&quot;</font>)
<em id='it2921'
>19: </em>           (<font color="#1919af"><strong id='bold2922'
>&lt;INPUT&gt;</strong></font> <strong id='bold2924'
>:type</strong> <font color="red">&quot;submit&quot;</font> <strong id='bold2927'
>:name</strong> <font color="red">&quot;btnG&quot;</font> <strong id='bold2930'
>:value</strong> <font color="red">&quot;reverse&quot;</font>)))
</pre>
</DIV><br>
<center><small><strong>Fig. 8:</strong> A complete HOP program defining two services.</small></center><br><p id='paragraph1968'
>When this program is executed, it first binds two services:
<font color="blue"><tt id='tt1959'
>portal</tt></font> line <em id='it1961'
><i id='line-ref'
><a href="article.html#1" class="inbound">1</a></i></em> and <font color="blue"><tt id='tt1962'
>rev</tt></font> line <em id='it1964'
><i id='line-ref'
><a href="article.html#7" class="inbound">7</a></i></em>. Then,
line <em id='it1965'
><i id='line-ref'
><a href="article.html#13" class="inbound">13</a></i></em>, it elaborates an answer which is an HTML tree
containing, line <em id='it1966'
><i id='line-ref'
><a href="article.html#15" class="inbound">15</a></i></em>, a call to the first service and,
line <em id='it1967'
><i id='line-ref'
><a href="article.html#17" class="inbound">17</a></i></em>, a call to the second service.</p><p id='paragraph1971'
>Similarly to anonymous functions, Hop supports anonymous
services which are not bound to any public URL.
They are introduced by the form <font color="blue"><tt id='tt1969'
>service</tt></font>:</p><pre id='pre1972'
></pre>
<DIV class='prog-border'><pre class="server" id='prog1978'
>   (service (<em id='it1973'
>&lt;ident&gt;</em><sub id='sub1976'
><small><small><em id='it1974'
>0</em></small></small></sub> ...)
      <em id='it1977'
>&lt;expression&gt;</em>)
</pre>
</DIV><pre id='pre1979'
></pre>
<p id='paragraph1988'
>Anonymous services are illustrated on the example presented
in Figure <a href="article.html#An-example-of-anonymous-services." class="inbound">9</a>.  This Hop program
manages a dynamic list of items. The form started at line <em id='it1980'
><i id='line-ref'
><a href="article.html#5" class="inbound">5</a></i></em>
adds new entries. Clicking the submit button of line <em id='it1981'
><i id='line-ref'
><a href="article.html#8" class="inbound">8</a></i></em>,
calls the anonymous service defined in line <em id='it1982'
><i id='line-ref'
><a href="article.html#6" class="inbound">6</a></i></em>. On the
server, this service recursively calls the function <font color="blue"><tt id='tt1983'
>loop</tt></font>,
defined in line <em id='it1985'
><i id='line-ref'
><a href="article.html#1" class="inbound">1</a></i></em>, with the value of the input entry of line <em id='it1986'
><i id='line-ref'
><a href="article.html#7" class="inbound">7</a></i></em> added to the list.  The forms
of line <em id='it1987'
><i id='line-ref'
><a href="article.html#13" class="inbound">13</a></i></em> works in a similar way but instead of adding
elements they remove elements one at a time.</p><br class="figure" id='An example of anonymous services.'
><a name="An-example-of-anonymous-services."></a>
<DIV class='prog-border'><pre class="hop" id='prog2012'
><em id='it2933'
> 1: </em><a name="1" class="mark"></a>(<strong id='bold2934'
>let</strong> loop ((items (list <font color="red">&quot;foo&quot;</font> <font color="red">&quot;bar&quot;</font> <font color="red">&quot;gee&quot;</font>))) 
<em id='it2938'
> 2: </em>   (<font color="#1919af"><strong id='bold2939'
>&lt;HTML&gt;</strong></font>
<em id='it2941'
> 3: </em>      (<font color="#1919af"><strong id='bold2942'
>&lt;BODY&gt;</strong></font>
<em id='it2944'
> 4: </em>         (<font color="#1919af"><strong id='bold2945'
>&lt;H3&gt;</strong></font> <font color="red">&quot;To do list&quot;</font>)
<em id='it2948'
> 5: </em><a name="5" class="mark"></a>         (<font color="#1919af"><strong id='bold2949'
>&lt;FORM&gt;</strong></font> 
<em id='it2951'
> 6: </em><a name="6" class="mark"></a>            <strong id='bold2952'
>:action</strong> (<strong id='bold2954'
>service</strong> (new) (loop (cons new items))) 
<em id='it2955'
> 7: </em><a name="7" class="mark"></a>            (<font color="#1919af"><strong id='bold2956'
>&lt;INPUT&gt;</strong></font> <strong id='bold2958'
>:name</strong> <font color="red">&quot;new&quot;</font> <strong id='bold2961'
>:type</strong> <font color="red">&quot;text&quot;</font> <strong id='bold2964'
>:size</strong> 40) 
<em id='it2966'
> 8: </em><a name="8" class="mark"></a>            (<font color="#1919af"><strong id='bold2967'
>&lt;INPUT&gt;</strong></font> <strong id='bold2969'
>:type</strong> <font color="red">&quot;submit&quot;</font> <strong id='bold2972'
>:value</strong> <font color="red">&quot;add new item&quot;</font>)) 
<em id='it2975'
> 9: </em>         (<font color="#1919af"><strong id='bold2976'
>&lt;TABLE&gt;</strong></font>
<em id='it2978'
>10: </em>            (map (<strong id='bold2979'
>lambda</strong> (item)
<em id='it2980'
>11: </em>                    (<font color="#1919af"><strong id='bold2981'
>&lt;TR&gt;</strong></font>
<em id='it2983'
>12: </em>                       (<font color="#1919af"><strong id='bold2984'
>&lt;TD&gt;</strong></font> item)
<em id='it2986'
>13: </em><a name="13" class="mark"></a>                       (<font color="#1919af"><strong id='bold2987'
>&lt;TD&gt;</strong></font> (<font color="#1919af"><strong id='bold2989'
>&lt;FORM&gt;</strong></font> 
<em id='it2991'
>14: </em>                                <strong id='bold2992'
>:action</strong> (<strong id='bold2994'
>service</strong> () (loop (delete! item items)))
<em id='it2995'
>15: </em>                                (<font color="#1919af"><strong id='bold2996'
>&lt;INPUT&gt;</strong></font> <strong id='bold2998'
>:type</strong> <font color="red">&quot;submit&quot;</font> <strong id='bold3001'
>:value</strong> <font color="red">&quot;remove&quot;</font>)))))
<em id='it3004'
>16: </em>                 items)))))
</pre>
</DIV><br>
<center><small><strong>Fig. 9:</strong> An example of anonymous services.</small></center><br></div>
<!-- HOP service calls -->
<a name="HOP-service-calls"></a>
<div class="subsubsection-atitle"><h4>4.3.2 HOP service calls</h4></div><div class="subsubsection">
<p id='paragraph2014'
>The service calls presented in Section <a href="article.html#HOP-service-definition" class="inbound"><span class="refscreen">HOP service definition</span><span class="refprint">4.3.1</span></a> suffer a strong restriction: they can only produce
complete web pages. By the definition of HTTP and HTML they can hardly be
used to compute partial results. In order to work around this
limitation, web browsers have introduced a new communication
means which enables clients to call services from
servers and which enables clients to handle, as they wish, the results
of the calls. The term <em id='emph2013'
>Ajax</em> has been coined for denoting programs 
using this capacity. This section, presents its support in Hop.</p><p id='paragraph2019'
>In addition to the <font color="blue"><tt id='tt2015'
>&lt;A&gt;</tt></font> and <font color="blue"><tt id='tt2017'
>&lt;FORM&gt;</tt></font> function
invocations, any Hop service can be called, from the GUI stratum, with
the following form:</p><pre id='pre2020'
></pre>
<DIV class='prog-border'><pre class="html" id='prog2028'
>  (with-hop (<em id='it2021'
>service</em> <em id='it2022'
>arg</em><sub id='sub2025'
><small><small><small><em id='it2023'
>0</em></small></small></small></sub> ...)
     [(lambda (h) <em id='emph2026'
>...success expression...</em>)
      [(lambda (h) <em id='emph2027'
>...failure expression...</em>)]])
</pre>
</DIV><pre id='pre2029'
></pre>
<p id='paragraph2048'
>The <font color="blue"><tt id='tt2030'
>with-hop</tt></font> form calls the service <font color="blue"><tt id='tt2033'
><em id='it2032'
>service</em></tt></font> with the arguments, <font color="blue"><tt id='tt2039'
><em id='it2035'
>arg</em><sub id='sub2038'
><small><small><small><em id='it2036'
>0</em></small></small></small></sub></tt></font>, .... When the call completes, on success, the
optional GUI call-back procedure <font color="blue"><tt id='tt2042'
><em id='it2041'
>success</em></tt></font> is called. On
failure, the optional call-back <font color="blue"><tt id='tt2045'
><em id='it2044'
>failure</em></tt></font> is called. Both
call-back procedures accept one argument which is the result of the
evaluation of the service on the main stratum. The example of Figure
<a href="article.html#An-example-of-function-call." class="inbound">10</a> shows an example of service call. In the
GUI stratum, it invokes a service that returns the local date of the
server which is displayed in a dialog box (line <em id='it2047'
><i id='line-ref'
><a href="article.html#6" class="inbound">6</a></i></em>).</p><br class="figure" id='An example of function call.'
><a name="An-example-of-function-call."></a>
<DIV class='prog-border'><pre class="hop" id='prog2054'
><em id='it3005'
>1: </em>(<font color="#6959cf"><strong id='bold3006'
>define-service</strong></font> (server-date<font color="#6959cf"><strong id='bold3008'
>)</strong></font>
<em id='it3010'
>2: </em>   (current-date))
<em id='it3011'
>3: </em>
<em id='it3012'
>4: </em>(<font color="#1919af"><strong id='bold3013'
>&lt;HTML&gt;</strong></font>
<em id='it3015'
>5: </em>  (<font color="#1919af"><strong id='bold3016'
>&lt;BUTTON&gt;</strong></font>
<em id='it3018'
>6: </em><a name="6" class="mark"></a>     <strong id='bold3019'
>:onclick</strong> <font color="red"><strong id='bold3021'
>~</strong></font>(<font color="red"><strong id='bold3023'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold3025'
>$server-date</strong></font>) (<strong id='bold3027'
>lambda</strong> (h) (alert h)))
<em id='it3028'
>7: </em>      <font color="red">&quot;Server time&quot;</font>))
</pre>
</DIV><br>
<center><small><strong>Fig. 10:</strong> An example of function call.</small></center><br><p id='paragraph2055'
>Compound data structure can transit from servers to clients
and vice versa. The following example sends a list from the client to the
server which, in turn, builds an HTML page containing a table and sends
it back to the client. This new table replaces the initial
empty element.</p><br class="figure" id='Arguments of function calls.'
><a name="Arguments-of-function-calls."></a>
<DIV class='prog-border'><pre class="hop" id='prog2064'
><em id='it3030'
> 1: </em>(<font color="#6959cf"><strong id='bold3031'
>define-service</strong></font> (add10 lst<font color="#6959cf"><strong id='bold3033'
>)</strong></font>
<em id='it3035'
> 2: </em>   (<font color="#1919af"><strong id='bold3036'
>&lt;TABLE&gt;</strong></font>
<em id='it3038'
> 3: </em>      (<font color="#1919af"><strong id='bold3039'
>&lt;TR&gt;</strong></font>
<em id='it3041'
> 4: </em>         (map (<strong id='bold3042'
>lambda</strong> (e) (<font color="#1919af"><strong id='bold3043'
>&lt;TD&gt;</strong></font> (+ 10 e))) lst)))))
<em id='it3045'
> 5: </em>
<em id='it3046'
> 6: </em>(<font color="#1919af"><strong id='bold3047'
>&lt;HTML&gt;</strong></font>
<em id='it3049'
> 7: </em>   (<font color="#1919af"><strong id='bold3050'
>&lt;HEAD&gt;</strong></font> (<font color="#1919af"><strong id='bold3052'
>&lt;HOP-HEAD&gt;</strong></font>))
<em id='it3054'
> 8: </em>   (<strong id='bold3055'
>let</strong> ((el (<font color="#1919af"><strong id='bold3056'
>&lt;DIV&gt;</strong></font> <font color="red">&quot;&quot;</font>)))
<em id='it3059'
> 9: </em>      (<font color="#1919af"><strong id='bold3060'
>&lt;BUTTON&gt;</strong></font>
<em id='it3062'
>10: </em>         <strong id='bold3063'
>:onclick</strong> <font color="red"><strong id='bold3065'
>~</strong></font>(<font color="red"><strong id='bold3067'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold3069'
>$add10</strong></font> (list 1 2 3))
<em id='it3071'
>11: </em>                      (<strong id='bold3072'
>lambda</strong> (h)
<em id='it3073'
>12: </em>                         (<strong id='bold3074'
>set!</strong> <font color="#00cf00"><strong id='bold3075'
>$el.innerHTML</strong></font> h)))
<em id='it3077'
>13: </em>         el)))
</pre>
</DIV><br>
<center><small><strong>Fig. 11:</strong> Arguments of function calls.</small></center><br><p id='paragraph2065'
>Because compound values can be exchanged, we could decide
to modify the previous program in order to ship a list, from the server
to the client, and construct the new HTML table in the client. This 
modification is presented Figure <a href="article.html#Sending-complex-data-structures." class="inbound">12</a>.</p><br class="figure" id='Sending complex data structures.'
><a name="Sending-complex-data-structures."></a>
<DIV class='prog-border'><pre class="hop" id='prog2074'
><em id='it3078'
> 1: </em>(<font color="#6959cf"><strong id='bold3079'
>define-service</strong></font> (add10 lst<font color="#6959cf"><strong id='bold3081'
>)</strong></font>
<em id='it3083'
> 2: </em>   (map (<strong id='bold3084'
>lambda</strong> (e) (+ 10 e)) lst))
<em id='it3085'
> 3: </em>
<em id='it3086'
> 4: </em>(<font color="#1919af"><strong id='bold3087'
>&lt;HTML&gt;</strong></font>
<em id='it3089'
> 5: </em>   (<font color="#1919af"><strong id='bold3090'
>&lt;HEAD&gt;</strong></font> (<font color="#1919af"><strong id='bold3092'
>&lt;HOP-HEAD&gt;</strong></font>))
<em id='it3094'
> 6: </em>   (<strong id='bold3095'
>let</strong> ((el (<font color="#1919af"><strong id='bold3096'
>&lt;DIV&gt;</strong></font> <font color="red">&quot;&quot;</font>)))
<em id='it3099'
> 7: </em>      (<font color="#1919af"><strong id='bold3100'
>&lt;BUTTON&gt;</strong></font>
<em id='it3102'
> 8: </em>         <strong id='bold3103'
>:onclick</strong> <font color="red"><strong id='bold3105'
>~</strong></font>(<font color="red"><strong id='bold3107'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold3109'
>$add10</strong></font> (list 1 2 3))
<em id='it3111'
> 9: </em>                      (<strong id='bold3112'
>lambda</strong> (h)
<em id='it3113'
>10: </em>                         (<strong id='bold3114'
>let</strong> ((t (<font color="#1919af"><strong id='bold3115'
>&lt;TABLE&gt;</strong></font> (<font color="#1919af"><strong id='bold3117'
>&lt;TR&gt;</strong></font> (map <font color="#1919af"><strong id='bold3119'
>&lt;TD&gt;</strong></font> h))) ))
<em id='it3121'
>11: </em>                            (dom-remove-child!
<em id='it3122'
>12: </em>                             <font color="#00cf00"><strong id='bold3123'
>$el</strong></font> (array-ref (dom-child-nodes <font color="#00cf00"><strong id='bold3125'
>$el</strong></font>) 0))
<em id='it3127'
>13: </em>                            (dom-append-child! <font color="#00cf00"><strong id='bold3128'
>$el</strong></font> t))))
<em id='it3130'
>14: </em>         el)))
</pre>
</DIV><br>
<center><small><strong>Fig. 12:</strong> Sending complex data structures.</small></center><br><p id='paragraph2076'
>In addition to enable communications from clients to servers
the form <tt id='tt2075'
>with-hop</tt> can also be used to establish a communication
between two servers. In that case, an extra parameter denoting the
distant server is added. For instance, the following code can
be used to fetch the date from a remote server:</p><pre id='pre2077'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog2082'
>(<font color="red"><strong id='bold3131'
>with-hop</strong></font> <strong id='bold3133'
>:host</strong> <font color="red">&quot;http://remote.host:8080&quot;</font> (<font color="#00cf00"><strong id='bold3136'
>$server-date</strong></font>)
   (<strong id='bold3138'
>lambda</strong> (h) ...))
</pre>
</DIV><pre id='pre2083'
></pre>
<p id='paragraph2089'
>This example supposes that there is a Hop server listening to the 
socket port <tt id='tt2084'
>8080</tt> of the computer named <tt id='tt2085'
>remote.host</tt>. It
also supposes that this server implements the service <tt id='tt2086'
>server-date</tt>.
When one has to fetch information from a non Hop server, the form
<tt id='tt2087'
>with-url</tt> can be used. It acts as <tt id='tt2088'
>with-hop</tt> except that it
does not invoke a service on a distant server, it directly fetches the
content of a document. Example:</p><DIV class='prog-border'><pre class="hop" id='prog2093'
>(<font color="red"><strong id='bold3139'
>with-url</strong></font> <font color="red">&quot;http://www.inria.fr/&quot;</font>
   (<strong id='bold3142'
>lambda</strong> (h) (xml-parse h ...)))
</pre>
</DIV></div>
</div>
<!-- HOP Event loops -->
<a name="HOP-Event-loops"></a>
<div class="subsection-atitle"><h3>4.4 HOP Event loops</h3></div><div class="subsection">
<p id='paragraph2094'
>Hop provides two different kinds of event loops. The first
ones are used to initiate, in the GUI stratum, computations at regular
time intervals. Since, they are roughly equivalent to the JavaScript timer
facilities, we only present them with the example shown Figure <a href="article.html#HOP-timer-loops." class="inbound">13</a>. This program polls every five seconds the
server time which is updated on the client display.</p><br class="figure" id='HOP timer loops.'
><a name="HOP-timer-loops."></a>
<DIV class='prog-border'><pre class="hop" id='prog2103'
><em id='it3143'
> 1: </em>(<font color="#1919af"><strong id='bold3144'
>&lt;HTML&gt;</strong></font>
<em id='it3146'
> 2: </em>   (<font color="#1919af"><strong id='bold3147'
>&lt;HEAD&gt;</strong></font> (<font color="#1919af"><strong id='bold3149'
>&lt;HOP-HEAD&gt;</strong></font>))
<em id='it3151'
> 3: </em>   (<font color="#1919af"><strong id='bold3152'
>&lt;BODY&gt;</strong></font>
<em id='it3154'
> 4: </em>      (<strong id='bold3155'
>let</strong> ((clock (<font color="#1919af"><strong id='bold3156'
>&lt;DIV&gt;</strong></font> <font color="red">&quot;&quot;</font>)))
<em id='it3159'
> 5: </em>         (<font color="#1919af"><strong id='bold3160'
>&lt;TIMEOUT-EVENT&gt;</strong></font>
<em id='it3162'
> 6: </em>            <strong id='bold3163'
>:timeout</strong> 5000
<em id='it3165'
> 7: </em>            <strong id='bold3166'
>:handler</strong> <font color="red"><strong id='bold3168'
>~</strong></font>(<font color="red"><strong id='bold3170'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold3172'
>$</strong></font>(<strong id='bold3174'
>service</strong> () (current-date)))
<em id='it3175'
> 8: </em>                         (<strong id='bold3176'
>lambda</strong> (h)
<em id='it3177'
> 9: </em>                            (<strong id='bold3178'
>set!</strong> <font color="#00cf00"><strong id='bold3179'
>$clock.innerHTML</strong></font> h)))
<em id='it3181'
>10: </em>            clock))))
</pre>
</DIV><br>
<center><small><strong>Fig. 13:</strong> HOP timer loops.</small></center><br><p id='paragraph2108'
>Hop also provides an event mechanism which prevents client
to busy wait. These events are first declared on the server, that is
in the main stratum of a Hop program. In the GUI stratum, clients
register to these events by the means of the dedicated markup <font color="blue"><tt id='tt2104'
>&lt;HOP-EVENT&gt;</tt></font>.  When a server emits an event, registered clients are
notified. The implementation of <font color="blue"><tt id='tt2106'
>&lt;HOP-EVENT&gt;</tt></font> liberates clients
from checking periodically event notifications. This is, to our
knowledge, another technical innovation brought by Hop.</p><p id='paragraph2111'
>Events are instances of the <font color="blue"><tt id='tt2109'
>hop-event</tt></font> class. The function 
of the main stratum that signals an event has the following prototype:</p><pre id='pre2112'
></pre>
<DIV class='prog-border'><pre class="server" id='prog2114'
>   signal-hop-event!: <SPAN class='type'><tt id='tt2113'
>event &#215; &lt;value&gt; &#8594; unit</tt></SPAN>
</pre>
</DIV><pre id='pre2115'
></pre>
<p id='paragraph2118'
>The markup <font color="blue"><tt id='tt2116'
>&lt;HOP-EVENT&gt;</tt></font> has the following shape:</p><pre id='pre2119'
></pre>
<DIV class='prog-border'><pre class="html" id='prog2122'
>(&lt;HOP-EVENT&gt;
   :event <em id='it2120'
>a-hop-event</em>
   :handler <em id='it2121'
>a-client-code</em>)
</pre>
</DIV><pre id='pre2123'
></pre>
<p id='paragraph2124'
>For the sake of the example, let us study a variation over the
example of Figure <a href="article.html#HOP-timer-loops." class="inbound">13</a>. In this second
version, the server initiates the communication with the client. That
is, the client does not explicitly poll the server. It displays the
server time when the server signals the event.</p><br class="figure" id='HOP timer loops without client busy wait.'
><a name="HOP-timer-loops-without-client-busy-wait."></a>
<DIV class='prog-border'><pre class="hop" id='prog2139'
><em id='it3182'
> 1: </em><a name="1" class="mark"></a>(<font color="#6959cf"><strong id='bold3183'
>define</strong></font> evt (<strong id='bold3185'
>instantiate</strong><font color="#00cf00"><strong id='bold3186'
>::hop-event</strong></font> (name <font color="red">&quot;server time event&quot;</font><font color="#6959cf"><strong id='bold3189'
>)</strong></font>)) 
<em id='it3191'
> 2: </em>
<em id='it3192'
> 3: </em><a name="3" class="mark"></a>(<font color="#ad4386"><strong id='bold3193'
>thread-start!</strong></font> 
<em id='it3195'
> 4: </em> (<font color="#ad4386"><strong id='bold3196'
>make-thread</strong></font>
<em id='it3198'
> 5: </em>  (<strong id='bold3199'
>lambda</strong> ()
<em id='it3200'
> 6: </em>     (<strong id='bold3201'
>let</strong> loop ()
<em id='it3202'
> 7: </em>        (sleep! 5000)
<em id='it3203'
> 8: </em>        (signal-hop-event! evt (current-time))
<em id='it3204'
> 9: </em>        (loop)))))
<em id='it3205'
>10: </em>
<em id='it3206'
>11: </em>(<font color="#1919af"><strong id='bold3207'
>&lt;HTML&gt;</strong></font>
<em id='it3209'
>12: </em>   (<font color="#1919af"><strong id='bold3210'
>&lt;HEAD&gt;</strong></font> (<font color="#1919af"><strong id='bold3212'
>&lt;HOP-HEAD&gt;</strong></font>))
<em id='it3214'
>13: </em>   (<font color="#1919af"><strong id='bold3215'
>&lt;BODY&gt;</strong></font>
<em id='it3217'
>14: </em>      (<strong id='bold3218'
>let</strong> ((clock (<font color="#1919af"><strong id='bold3219'
>&lt;DIV&gt;</strong></font> <font color="red">&quot;&quot;</font>)))
<em id='it3222'
>15: </em>         (<font color="#1919af"><strong id='bold3223'
>&lt;HOP-EVENT&gt;</strong></font>
<em id='it3225'
>16: </em>            <strong id='bold3226'
>:event</strong> evt
<em id='it3228'
>17: </em><a name="17" class="mark"></a>            <strong id='bold3229'
>:handler</strong> <font color="red"><strong id='bold3231'
>~</strong></font>(<strong id='bold3233'
>set!</strong> <font color="#00cf00"><strong id='bold3234'
>$clock.innerHTML</strong></font> event) 
<em id='it3236'
>18: </em>            clock))))
</pre>
</DIV><br>
<center><small><strong>Fig. 14:</strong> HOP timer loops without client busy wait.</small></center><br><p id='paragraph2155'
>At Line <em id='it2140'
><i id='line-ref'
><a href="article.html#3" class="inbound">3</a></i></em> a thread is spawned on
the server. This thread pauses during 5 seconds and then signals the
event <font color="blue"><tt id='tt2141'
>evt</tt></font> defined in line <em id='it2143'
><i id='line-ref'
><a href="article.html#1" class="inbound">1</a></i></em>. The form <tt id='tt2144'
>instantiate</tt>
creates an instance of the class <tt id='tt2145'
>hop-event</tt>. The event
is intercepted on the GUI stratum in line <em id='it2146'
><i id='line-ref'
><a href="article.html#17" class="inbound">17</a></i></em>. In the <font color="blue"><tt id='tt2147'
>:handler</tt></font> block, following the JavaScript tradition of event
handling, the variable <font color="blue"><tt id='tt2149'
>event</tt></font> is automatically bound to the
event that has been intercepted. The content of the <font color="blue"><tt id='tt2151'
>clock</tt></font> 
<font color="blue"><tt id='tt2153'
>&lt;DIV&gt;</tt></font> is replaced with the value carried by the event.</p><p id='paragraph2160'
>One may object that we have not eliminated the busy wait but
moved it to the server. While, undubitably true, this is not a
weakness of Hop. The point of this example is to show that
<em id='emph2156'
>clients</em> may avoid busy waiting server events using the
<font color="blue"><tt id='tt2157'
>&lt;HOP-EVENT&gt;</tt></font> markups. It is up to the server to implement the
appropriate signaling mechanism. The point of this section is only
to show that the Hop notification implements a server <em id='emph2159'
>push</em>
method.</p></div>
</div><br>
</div>
<div class="section" id="Example"><!-- Example -->
<a name="Example"></a>
<div class="section-atitle"><h3><font color="black">5 Example</font>
</h3></div><div class="section">
<p id='paragraph2161'
>In this section, we show a small Hop application. We present
an overly simplified IMAP client that uses a web interface. As shown
in the screenshot of Figure <a href="article.html#Webmail-a-screenshot-of-the-simple-HOP-webmail-in-Firefox." class="inbound">15</a>, it
presents a table with two columns. The left column displays the list of
folders found on the IMAP servers. The upper right column shows the
list of messages of the selected folder. The lower right column shows
the body of the selected message. The application is interactive. Folders and
messages are accessed on-demand using mouse clicks.</p><br class="figure" id='Webmail, a screenshot of the simple HOP webmail in Firefox.'
><a name="Webmail-a-screenshot-of-the-simple-HOP-webmail-in-Firefox."></a>
<center id='center2163'
><img src="webmail-short.png" border="0" alt="" width="88%"></center>
<br>
<center><small><strong>Fig. 15:</strong> Webmail, a screenshot of the simple HOP webmail in Firefox.</small></center><br><p id='paragraph2166'
>Hop provides a library for accessing IMAP servers.  All the
function that belong to this API are prefixed with <font color="blue"><tt id='tt2164'
>imap-</tt></font>. This API being self explanatory, it is not discussed here. In
order to make the application as compact as possible, we don't provide
the IMAP client with a GUI for connecting to the IMAP server. Instead,
the connection to the IMAP server is held in a global variable:</p><pre id='pre2167'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog2172'
>(<font color="#6959cf"><strong id='bold3237'
>define</strong></font> connection
   (imap-login
      (make-client-socket <font color="red">&quot;imap.laposte.net&quot;</font> 993<font color="#6959cf"><strong id='bold3240'
>)</strong></font>
      <font color="red">&quot;foo&quot;</font> <font color="red">&quot;XXX&quot;</font>))
</pre>
</DIV><pre id='pre2173'
></pre>
<p id='paragraph2178'
>Then comes the heart of the application. It uses two Hop widgets,
<font color="blue"><tt id='tt2174'
>&lt;TREE&gt;</tt></font> and <font color="blue"><tt id='tt2176'
>&lt;PANED&gt;</tt></font> which are popular widgets in traditional
GUI programming and which are supported by Hop. This is presented in
Figure <a href="article.html#Webmail-main-program." class="inbound">16</a>.</p><br class="figure" id='Webmail, main program.'
><a name="Webmail-main-program."></a>
<DIV class='prog-border'><pre class="hop" id='prog2204'
>(<strong id='bold3244'
>let</strong> ((folder (<font color="#1919af"><strong id='bold3245'
>&lt;DIV&gt;</strong></font>))
      (message (<font color="#1919af"><strong id='bold3247'
>&lt;DIV&gt;</strong></font>)))
   (<font color="#6959cf"><strong id='bold3249'
>define</strong></font> message-show ...<font color="#6959cf"><strong id='bold3251'
>)</strong></font>
   (<font color="#6959cf"><strong id='bold3253'
>define</strong></font> folder-summary ...<font color="#6959cf"><strong id='bold3255'
>)</strong></font>
   (<font color="#6959cf"><strong id='bold3257'
>define</strong></font> (<font color="#1919af"><strong id='bold3259'
>&lt;IMAP-TREE&gt;</strong></font> connection<font color="#6959cf"><strong id='bold3261'
>)</strong></font> ...)
   (<font color="#1919af"><strong id='bold3263'
>&lt;HTML&gt;</strong></font>
      (<font color="#1919af"><strong id='bold3265'
>&lt;HEAD&gt;</strong></font>
          <strong id='bold3267'
>:css</strong> <font color="red">&quot;hop-paned.css&quot;</font> <strong id='bold3270'
>:css</strong> <font color="red">&quot;hop-tree.css&quot;</font> <strong id='bold3273'
>:css</strong> <font color="red">&quot;hop-mail.css&quot;</font>
          <strong id='bold3276'
>:jscript</strong> <font color="red">&quot;hop-paned.js&quot;</font> <strong id='bold3279'
>:jscript</strong> <font color="red">&quot;hop-tree.js&quot;</font>)
      (<font color="#1919af"><strong id='bold3282'
>&lt;BODY&gt;</strong></font>
         (<font color="#1919af"><strong id='bold3284'
>&lt;PANED&gt;</strong></font> <strong id='bold3286'
>:fraction</strong> 30
            (<font color="#1919af"><strong id='bold3288'
>&lt;PAN&gt;</strong></font>
               (<font color="#1919af"><strong id='bold3290'
>&lt;IMAP-TREE&gt;</strong></font> connection))
            (<font color="#1919af"><strong id='bold3292'
>&lt;PAN&gt;</strong></font>
               (<font color="#1919af"><strong id='bold3294'
>&lt;TABLE&gt;</strong></font> <strong id='bold3296'
>:width</strong> <font color="red">&quot;100%&quot;</font> <strong id='bold3299'
>:border</strong> <font color="red">&quot;2px&quot;</font>
                  (<font color="#1919af"><strong id='bold3302'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold3304'
>&lt;TD&gt;</strong></font> <strong id='bold3306'
>:class</strong> <font color="red">&quot;folder&quot;</font> <strong id='bold3309'
>:valign</strong> 'top folder))
                  (<font color="#1919af"><strong id='bold3311'
>&lt;TR&gt;</strong></font> (<font color="#1919af"><strong id='bold3313'
>&lt;TD&gt;</strong></font> <strong id='bold3315'
>:class</strong> <font color="red">&quot;message&quot;</font> <strong id='bold3318'
>:valign</strong> 'top message))))))))
</pre>
</DIV><br>
<center><small><strong>Fig. 16:</strong> Webmail, main program.</small></center><br><p id='paragraph2211'
>The two <font color="blue"><tt id='tt2205'
>&lt;DIV&gt;</tt></font>s, <font color="blue"><tt id='tt2207'
>folder</tt></font> and <font color="blue"><tt id='tt2209'
>message</tt></font> respectively contain the list of folders and the body
of the selected message. The left column of the application is a tree
whose label is the name of the IMAP server and whose leaves are
labeled with the names of the folders.</p><pre id='pre2212'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog2221'
>(<font color="#6959cf"><strong id='bold3320'
>define</strong></font> (<font color="#1919af"><strong id='bold3322'
>&lt;IMAP-TREE&gt;</strong></font> connection<font color="#6959cf"><strong id='bold3324'
>)</strong></font>
   (<font color="#1919af"><strong id='bold3326'
>&lt;TREE&gt;</strong></font>
    (<font color="#1919af"><strong id='bold3328'
>&lt;TRHEAD&gt;</strong></font>
      (socket-hostname connection))
    (<font color="#1919af"><strong id='bold3330'
>&lt;TRBODY&gt;</strong></font>
      (map (<strong id='bold3332'
>lambda</strong> (f)
              (<font color="#1919af"><strong id='bold3333'
>&lt;TRLEAF&gt;</strong></font>
               (<font color="#1919af"><strong id='bold3335'
>&lt;TT&gt;</strong></font> <strong id='bold3337'
>:class</strong> <font color="red">&quot;summary&quot;</font> 
                 <strong id='bold3340'
>:onclick</strong> 
                 <font color="red"><strong id='bold3342'
>~</strong></font>(<font color="red"><strong id='bold3344'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold3346'
>$folder-summary</strong></font> <font color="#00cf00"><strong id='bold3348'
>$f</strong></font>)
		     (<strong id='bold3350'
>lambda</strong> (h) (<strong id='bold3351'
>set!</strong> <font color="#00cf00"><strong id='bold3352'
>$folder.innerHTML</strong></font> h)))
                 f)))
           (imap-folders connection)))))
</pre>
</DIV><pre id='pre2222'
></pre>
<p id='paragraph2229'
>When a leaf of this tree is clicked-in, the service of the main
stratum <font color="blue"><tt id='tt2223'
>folder-summary</tt></font> is invoked with the name of the folder.
The result of this function call fills the <font color="blue"><tt id='tt2225'
>folder</tt></font> <font color="blue"><tt id='tt2227'
>&lt;DIV&gt;</tt></font>.
This is presented in Figure <a href="article.html#Webmail-showing-the-messages-of-a-folder." class="inbound">17</a>.</p><br class="figure" id='Webmail, showing the messages of a folder.'
><a name="Webmail-showing-the-messages-of-a-folder."></a>
<DIV class='prog-border'><pre class="hop" id='prog2239'
>(<font color="#6959cf"><strong id='bold3354'
>define</strong></font> folder-summary
   (<strong id='bold3356'
>service</strong> (folder<font color="#6959cf"><strong id='bold3357'
>)</strong></font>
      (imap-folder-select connection folder)
      (<font color="#1919af"><strong id='bold3359'
>&lt;TABLE&gt;</strong></font> <strong id='bold3361'
>:class</strong> <font color="red">&quot;summary&quot;</font>
        (map (<strong id='bold3364'
>lambda</strong> (mh)
                (<font color="#1919af"><strong id='bold3365'
>&lt;TR&gt;</strong></font> <strong id='bold3367'
>:onclick</strong> <font color="red"><strong id='bold3369'
>~</strong></font>(<font color="red"><strong id='bold3371'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold3373'
>$message-show</strong></font> <font color="#00cf00"><strong id='bold3375'
>$folder</strong></font> <font color="#00cf00"><strong id='bold3377'
>$</strong></font>(car mh))
                                   (<strong id='bold3379'
>lambda</strong> (h) (<strong id='bold3380'
>set!</strong> <font color="#00cf00"><strong id='bold3381'
>$message.innerHTML</strong></font> h)))
                  (<font color="#1919af"><strong id='bold3383'
>&lt;TD&gt;</strong></font> (imap-header-get mh 'subject))
                  (<font color="#1919af"><strong id='bold3385'
>&lt;TD&gt;</strong></font> (imap-header-get mh 'from))
                  (<font color="#1919af"><strong id='bold3387'
>&lt;TD&gt;</strong></font> (imap-header-get mh 'date))))
              (imap-folder-headers connection)))))
</pre>
</DIV><br>
<center><small><strong>Fig. 17:</strong> Webmail, showing the messages of a folder.</small></center><br><p id='paragraph2246'
>The service <font color="blue"><tt id='tt2240'
>folder-summary</tt></font> builds a table with three columns
containing respectively the subject, the author, and the emission date
of the message. When such a message is clicked, the service
<font color="blue"><tt id='tt2242'
>message-show</tt></font> is called with two parameters, the folder name and
the message identifier. The result is used to fill the <font color="blue"><tt id='tt2244'
>message</tt></font>
box.</p><pre id='pre2247'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog2250'
><em id='it3389'
>3: </em>(<font color="#6959cf"><strong id='bold3390'
>define</strong></font> message-show
<em id='it3392'
>4: </em>   (<strong id='bold3393'
>service</strong> (folder msg<font color="#6959cf"><strong id='bold3394'
>)</strong></font>
<em id='it3396'
>5: </em>      (imap-folder-select connection folder)
<em id='it3397'
>6: </em>      (<font color="#1919af"><strong id='bold3398'
>&lt;PRE&gt;</strong></font> (imap-message-body connection msg))))
</pre>
</DIV><pre id='pre2251'
></pre>
</div><br>
</div>
<div class="section" id="Implementation"><!-- Implementation -->
<a name="Implementation"></a>
<div class="section-atitle"><h3><font color="black">6 Implementation</font>
</h3></div><div class="section">
<p id='paragraph2252'
>This section sketches the implementation of services and
events. Readers not interested in such technical details may freely
skip this section.</p><!-- Implementation of Services -->
<a name="Implementation-of-Services"></a>
<div class="subsection-atitle"><h3>6.1 Implementation of Services</h3></div><div class="subsection">
<p id='paragraph2254'
>Hop is currently implemented as a web server. It accepts
HTTP requests and it selects, according to the URL, the appropriate
treatment to execute. Services are implemented as couples containing
one function and one URL. That is, each time a service (anonymous or
not) is created, a new unique URL is generated, a new function is
created and the couple <em id='emph2253'
>{URL, function}</em> is stored inside a
table on the server.  When a request is intercepted, this table is
scanned for selecting the appropriate service to execute. When a
service is used in the GUI stratum, a reference to it is compiled to
JavaScript. At last, expressions of the GUI stratum are compiled on the fly to
JavaScript by a Hop-to-JavaScript compiler whose description is out of scope
of this present paper. Let us assume the following Hop expression:</p><pre id='pre2255'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog2260'
>(<font color="#1919af"><strong id='bold3400'
>&lt;BUTTON&gt;</strong></font>
    <strong id='bold3402'
>:onclick</strong> <font color="red"><strong id='bold3404'
>~</strong></font>(<font color="red"><strong id='bold3406'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold3408'
>$</strong></font>(<strong id='bold3410'
>service</strong> (x y) (+ x y)) 1 2)
                 ...)
    <font color="red">&quot;Click this link&quot;</font>)
</pre>
</DIV><pre id='pre2261'
></pre>
<p id='paragraph2262'
>The elaboration yields the following HTML document:</p><pre id='pre2263'
></pre>
<DIV class='prog-border'><pre class="html" id='prog2264'
><font color="#1919af"><strong id='bold3412'
>&lt;BUTTON</strong></font> onclick='with_hop(
  function() {
    return hop_service_url(<font color="red">&quot;/hop/???/4-57604278&quot;</font>,
                           [<font color="red">&quot;x&quot;</font>, <font color="red">&quot;y&quot;</font>],
                           arguments )
  }(1, 2), ...)'<font color="#1919af"><strong id='bold3417'
>&gt;</strong></font>
  <font color="red">&quot;Click this link&quot;</font>
<font color="#1919af"><strong id='bold3420'
>&lt;/BUTTON</strong></font><font color="#1919af"><strong id='bold3422'
>&gt;</strong></font>
</pre>
</DIV><pre id='pre2265'
></pre>
<p id='paragraph2268'
>The dynamically created URL <font color="blue"><tt id='tt2266'
>/hop/???/4-57604278</tt></font> is
the unique identifier associated with the service. The current
implementation of Hop is not able to reclaim these URLs. That is,
it keeps alive for ever all the services and their URLs. It never collects URLs
because we don't think that it exists a universal criterion allowing
URL reclaim. Obviously, we could adopt a solution based on time
stamping. For instance, we could arbitrarily decide to collect URL
after two or three hours. We are reluctant to adopt such a solution
but we are aware that this weakness has to be overcome in the future
versions of Hop. We are investigating a solution where the server
functions representing the services are encoded in the URL. More
precisely according to this solution it would be no longer necessary
to store the whole function on the server. Instead, only the
closure environment would be encoded and sent to the client (i.e. the 
lexical environment active when the service was created). If this approach
succeeds, it will remove the need for the table which binds URLs to
functions.</p><p id='paragraph2275'
>The JavaScript functions <font color="blue"><tt id='tt2269'
>with_hop</tt></font> and <font color="blue"><tt id='tt2271'
>hop_service_url</tt></font> are defined in the standard Hop GUI stratum
library. They are shipped with every generated page. As presented in
Section <a href="article.html#HOP-service-calls" class="inbound"><span class="refscreen">HOP service calls</span><span class="refprint">4.3.2</span></a> the form
<font color="blue"><tt id='tt2273'
>with-hop</tt></font> calls asynchronously a service.  It can be defined as:</p><pre id='pre2276'
></pre>
<DIV class='prog-border'><pre class="html" id='prog2285'
>function with_hop( service, success, failure ) <font color="red"><strong id='bold3424'
>{</strong></font>
 function callback( h ) <font color="red"><strong id='bold3426'
>{</strong></font>
  <strong id='bold3428'
>if</strong>( h.status == 200 ) 
    <strong id='bold3429'
>if</strong>(h.getAllResponseHeaders().indexOf(<font color="red">&quot;hop-json&quot;</font>)&gt;=0)
      <strong id='bold3431'
>return</strong> success( eval( h.responseText ) );
    <strong id='bold3432'
>else</strong>
      <strong id='bold3433'
>return</strong> success( h.responseText );
  <strong id='bold3434'
>else</strong> 
    <strong id='bold3435'
>return</strong> success( h );
 <font color="red"><strong id='bold3436'
>}</strong></font>;
  
 <strong id='bold3438'
>return</strong> hop( service, callback, failure );
<font color="red"><strong id='bold3439'
>}</strong></font>

</pre>
</DIV><pre id='pre2286'
></pre>
<p id='paragraph2289'
>The function <font color="blue"><tt id='tt2287'
>hop_service_url</tt></font> maps a service to a URL.
It could be implemented as:</p><pre id='pre2290'
></pre>
<DIV class='prog-border'><pre class="html" id='prog2296'
>function hop_service_url( service, formals, args ) <font color="red"><strong id='bold3441'
>{</strong></font>
   var len = formals.length;

   <strong id='bold3443'
>if</strong>( len == 0 ) <font color="red"><strong id='bold3444'
>{</strong></font>
      <strong id='bold3446'
>return</strong> service;
   <font color="red"><strong id='bold3447'
>}</strong></font> <strong id='bold3449'
>else</strong> <font color="red"><strong id='bold3450'
>{</strong></font>
      var url = service + <font color="red">&quot;?hop-encoding=hop&quot;</font>;
      var i;

      <strong id='bold3453'
>for</strong>( i = 0; i &lt; len; i++ ) <font color="red"><strong id='bold3454'
>{</strong></font>
         url += <font color="red">&quot;&amp;&quot;</font> + formals[ i ] + <font color="red">&quot;=&quot;</font> + hop_serialize( args[ i ] );
      <font color="red"><strong id='bold3458'
>}</strong></font>

      <strong id='bold3460'
>return</strong> url;
   <font color="red"><strong id='bold3461'
>}</strong></font>
<font color="red"><strong id='bold3463'
>}</strong></font>
</pre>
</DIV><pre id='pre2297'
></pre>
<p id='paragraph2303'
>The function <font color="blue"><tt id='tt2298'
>hop_serialize</tt></font> marshals JavaScript values
in a format compatible with the main stratum of Hop. 
When the server sends a value to the client which is not an HTML tree,
it adds a <tt id='tt2300'
>hop-json</tt> header in the message and it uses
the JSON external format that the client simply decodes with the
JavaScript <tt id='tt2301'
>eval</tt> function call. The library function <tt id='tt2302'
>hop</tt>,
whose code is not presented here, actually performs the JavaScript 
asynchronous call. It uses ad-hoc technics which are dependent of
the clients web browsers.</p></div>
<!-- Implementation of Events -->
<a name="Implementation-of-Events"></a>
<div class="subsection-atitle"><h3>6.2 Implementation of Events</h3></div><div class="subsection">
<p id='paragraph2323'
>The current implementation of the <font color="blue"><tt id='tt2304'
>&lt;HOP-EVENT&gt;</tt></font> markup
relies on services invocation. Waiting for an event is implemented as
invoking an asynchronous service that returns only when the event is
emitted from the client. More precisely, when an event <font color="blue"><tt id='tt2306'
>e1</tt></font> is
created, the server automatically generates a service <font color="blue"><tt id='tt2309'
>svc<sub id='sub2308'
>e1</sub></tt></font>. The markup <font color="blue"><tt id='tt2311'
>&lt;HOP-EVENT&gt;</tt></font> is compiled, during the
elaboration stage, as an invocation of <font color="blue"><tt id='tt2314'
>svc<sub id='sub2313'
>e1</sub></tt></font> (see
Section <a href="article.html#HOP-service-calls" class="inbound"><span class="refscreen">HOP service calls</span><span class="refprint">4.3.2</span></a>). This call
completes when the server emits the signal <font color="blue"><tt id='tt2316'
>e1</tt></font>. At that time,
the client receives the value associated with the event. It re-invokes
the service <font color="blue"><tt id='tt2319'
>svc<sub id='sub2318'
>e1</sub></tt></font> for waiting for other values and,
in parallel, it handles the received value. Assuming the library
function <font color="blue"><tt id='tt2321'
>hop_event</tt></font> whose definition looks like:</p><pre id='pre2324'
></pre>
<DIV class='prog-border'><pre class="html" id='prog2326'
>function hop_event( event, event_handler ) <font color="red"><strong id='bold3465'
>{</strong></font>
  var http = new XMLHttpRequest();
  var url = <font color="red">&quot;hop_event_wait?event=&quot;</font> + event;

  http.open( <font color="red">&quot;GET&quot;</font>, url, true );
  http.onreadystatechange = function() <font color="red"><strong id='bold3469'
>{</strong></font>
    <strong id='bold3471'
>if</strong>( http.readyState == 4 &amp;&amp; http.status == 200 ) <font color="red"><strong id='bold3472'
>{</strong></font>
       <font color="darkmagenta"><em id='it3474'
>// invokes the user handler</em></font>
       event_handler( http );
<font color="red"><strong id='bold3476'
>}</strong></font>
</pre>
</DIV><DIV class='prog-border'><pre class="html" id='prog2327'
>       <font color="darkmagenta"><em id='it3478'
>// recursively call the function in </em></font>
       <font color="darkmagenta"><em id='it3480'
>// order to wait new results</em></font>
       hop_event( event, event_handler );
    <font color="red"><strong id='bold3482'
>}</strong></font>
  <font color="red"><strong id='bold3484'
>}</strong></font>
  http.send( null );
<font color="red"><strong id='bold3486'
>}</strong></font>
</pre>
</DIV><pre id='pre2328'
></pre>
<p id='paragraph2331'
>The actual implementation takes care of portability issues.
The expression <font color="blue"><tt id='tt2329'
>(&lt;HOP-EVENT&gt; evt handler)</tt></font> is then compiled 
to:</p><DIV class='prog-border'><pre class="html" id='prog2332'
> 
hop_event( evt, handler );
</pre>
</DIV><pre id='pre2333'
></pre>
<p id='paragraph2336'
>This implementation prevents the client from busy waiting events
for the server because invoking a service using an <font color="blue"><tt id='tt2334'
>XMLHttpRequest</tt></font> is an asynchronous operation that does not involve
polling. Surprisingly, this simple technique appears to be robust and it
allows to implement passive wait on the client quite easily. It has been 
suggested by Marc Feeley who deserves most of its credit.</p></div>
</div><br>
</div>
<div class="section" id="Discussion-and-Related-work"><!-- Discussion and Related work -->
<a name="Discussion-and-Related-work"></a>
<div class="section-atitle"><h3><font color="black">7 Discussion and Related work</font>
</h3></div><div class="section">
<p id='paragraph2337'
>In this section we discuss the design orientation of Hop and we
present some related and future work.</p><!-- Related work -->
<a name="Related-work"></a>
<div class="subsection-atitle"><h3>7.1 Related work</h3></div><div class="subsection">
<p id='paragraph2344'
>Hop embraces in one unique language all the facets of web 
programming. It emphasizes compactness of programs and interactivity of
applications. It proposes a lightweight approach based on functional
programming. By contrast to previous studies, it does not enforce an
interaction model based on forms submissions [<a href="article.html#gfkf:esop2003" class="inbound">7</a>,<a href="article.html#gfkf:ase04" class="inbound">6</a>]. It follows an opposite direction to
previous studies that aimed at easing CGI programming in traditional
programming languages. The Meijer's CGI library [<a href="article.html#meijer:jfp00" class="inbound">11</a>] is a functional representative of this kind. Hop also
distinguishes from early works such as the <tt id='tt2338'
>&lt;bigwig&gt;</tt> project
[<a href="article.html#ss:popl00" class="inbound">13</a>,<a href="article.html#bmss:jcn99" class="inbound">1</a>] that are aimed for larger web
applications where <em id='emph2339'
>sessions</em>, <em id='emph2340'
>database integration</em>,
<em id='emph2341'
>security</em>, <em id='emph2342'
>static checking of dynamic web pages</em>,
and <em id='emph2343'
>concurrency</em> are important issues. Hop proposes a
solution for authoring web pages, programming the interactions between
the servers and the clients, and programming the reactions of the user
interfaces. In that sense, it is unrelated to languages such as
Mozilla's XUL or Microsoft XAML that focus on the programming of the
clients. XUL is the programming language of Mozilla which is, in
addition to being a web browser, a whole execution
environment. Hop is independent of any browser. It is used for
implementing applications that need server- and client-
programming. It can also be used for implementing applications that
execute totally on a server. For instance, it can be used for
implementing servers delivering music or for implementing tunneling via
HTTP. This kind of applications is out of scope of languages such as XUL.</p><p id='paragraph2349'
>One of the closest works to Hop is due to Philip Wadler and
his colleagues. The Links<a href="#footnote-footnote2346"><sup><small>1</small></sup></a>  programming
language shares the goal of Hop. Like Hop, Links is a functional
language that manages transparent function calls across the web. As
Hop a Links program is made of a single source file. Like Hop,
the client codes are compiled to JavaScript and server codes and
client codes can be interleaved. Contrary to Hop, Links uses only
one name space and functions are annotated with <tt id='tt2347'
>client</tt> or <tt id='tt2348'
>server</tt> marks depending on where they execute. This solution is
elegant because it allows the use of only one single syntactic
construction for calling either client functions and server
functions. The Hop expression:</p><pre id='pre2350'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog2353'
>(<font color="red"><strong id='bold3488'
>with-hop</strong></font> (<font color="#00cf00"><strong id='bold3490'
>$lookup</strong></font> n) (<strong id='bold3492'
>lambda</strong> (lst) ...))
</pre>
</DIV><pre id='pre2354'
></pre>
<p id='paragraph2355'
>in Links is nicely written:</p><pre id='pre2356'
></pre>
<DIV class='prog-border'><pre class="hop" id='prog2357'
>lst &lt;- (lookup n); ...
</pre>
</DIV><pre id='pre2358'
></pre>
<p id='paragraph2360'
>However, we think that this approach has several
weaknesses. First, we think that it is important to reflect, in the
syntax, that calling a server function is a different operation from
calling a client function. The two kinds of calls have totally
different implementation and execution costs. Another weakness is that 
the Links approach
gives the illusion that programming the client and programming the
server is the same. However, the two execution engines cannot support
the same set of operations. Some operations are meaningless on the server
and vice versa (for instance, getting the dimension of the graphical
user interface window is meaningless on the server). Next, we think
that the elaboration stage of Hop that allows to <em id='emph2359'
>inject</em>
server values in the client code is a strength. We hope that the
various examples of the paper are demonstrative enough.</p><p id='paragraph2362'
>The last difference between Links and Hop is the event loops
(see Section <a href="article.html#HOP-Event-loops" class="inbound"><span class="refscreen">HOP Event loops</span><span class="refprint">4.4</span></a>) that have no direct
equivalent construction in Links. However, Links offers <em id='emph2361'
>client
processes</em> that allow to establish asynchronous communications between
the clients and the servers. Hence, it might probably be possible to
implement Hop event loops on the top of Links processes.</p><!-- Database orientation -->
<a name="Database-orientation"></a>
<div class="subsubsection-atitle"><h4>7.1.1 Database orientation</h4></div><div class="subsubsection">
<p id='paragraph2363'
>Until recently, most of the web applications have adopted
the same architecture. On the one hand, a server hosts a database and
scripts that access it. On the other hand, a client, i.e. a browser,
implements the user interface to this server. This architecture is so
widely spread than many solutions have been conceived for easing the
development and maintenance of such applications. In the first place,
libraries have been developed. Windows ASP and Java JSP are two
representatives of such libraries. Because a language tuned for a
particular kind of applications might ease the development, languages
such as PHP have appeared. A PHP program is composed of static HTML
parts and PHP expressions that dynamically generate, on the server,
new HTML nodes. Databases are tightly integrated in the language and
in consequence, one might very concisely produce HTML documents from
database queries.</p><p id='paragraph2369'
>Since the rise of Ajax applications, new solutions try
to combine the compactness of PHP for programming databases accesses
and the programming of reactive graphical interfaces. The largely
advertised <em id='it2364'
>Ruby On Rails</em> is one of these solutions: it defines
itself as "a full-stack framework for developing <em id='emph2365'
>database-backed web applications</em> according to the
Model-View-Control pattern". In a Rails application, the user
interacts with an Ajax <em id='emph2366'
>view</em> of the database.  Requests to
this database are handled by a <em id='emph2367'
>controller</em> which is built on
a <em id='emph2368'
>model</em> which dynamically maps the tables of the database to
Ruby classes. This framework favors convention over configuration and
by this way tries to eliminate as much as possible the need for
hand-written code. Most of the code of a Rail application is
automatically generated from templates and database
introspection. Ruby on Rails goes beyond the objectives of a
programming language and is particulary efficient for the kind of
applications it is envisioned for.</p><p id='paragraph2370'
>Hop and Rails automatically generate URLs for server
services.  In Hop they are mapped to services (see Section <a href="article.html#HOP-services" class="inbound"><span class="refscreen">HOP services</span><span class="refprint">4.3</span></a>).  In Rails they are mapped to Ruby
methods. Contrarily to Hop, Rails does not support direct
parameters passing. Hop mainly eases the development of the
communication components of reactive web applications.  This facet is
not addressed by the previously mentioned system.</p></div>
<!-- Functional programming -->
<a name="Functional-programming"></a>
<div class="subsubsection-atitle"><h4>7.1.2 Functional programming</h4></div><div class="subsubsection">
<p id='paragraph2372'
>Like Hop, WASH/CGI is a linguistic approach to programming the
web.  It concentrates on CGI programming so it addresses problems
specific to this model such as persistency. Namely, WASH/CGI manages
sessions. This problem is eliminated by the design of Hop which
assumes an evaluator that is hosted by a full-fledged web server.
Contrarily to CGI, the execution of a Hop application is not split
into several execution chunks. WASH/CGI focuses on interactions based
on HTML forms. In particular, inspired by Hanus' Curry [<a href="article.html#hanus:padl01" class="inbound">8</a>], it automatically handles the <tt id='tt2371'
>action</tt>
attributes of this HTML markup. That is, WASH/CGI replaces the URL
of the HTML forms with an Haskell function. WASH/CGI transparently
associates a private URL and it automatically feeds the function
with the actual values found in the form.  Hop's services can be
viewed as a generalization of this approach because they can be used
in forms but also everywhere where a reference to a server is used, in any
JavaScript code, and in any event loop. Contrarily to Hop, WASH/CGI
does not support remote service call nor does it support event
loops and passive event waiting.</p></div>
<!-- Sessions and Continuations -->
<a name="Sessions-and-Continuations"></a>
<div class="subsubsection-atitle"><h4>7.1.3 Sessions and Continuations</h4></div><div class="subsubsection">
<p id='paragraph2380'
>We have learned in the late 1990's from C. Queinnec, that
most web applications have to deal with continuations. In his early
publication [<a href="article.html#queinnec:icfp00" class="inbound">12</a>] he has shown that a browser
is a device that can call continuations multiply and
simultaneously. Hence, he has concluded that an operator for capturing
and restoring continuations is a natural tool of choice for
implementing web pages. This point has been deeply developed and thoroughly
studied by the PLT Scheme team in various publications
[<a href="article.html#gfkf:esop2003" class="inbound">7</a>].

Scheme is one of the seldom languages to support continuations. The
<tt id='tt2373'
>call/cc</tt> (whose actual name is <em id='emph2374'
>call-with-current-continuation</em>) facility reifies a continuation
into a function that can be called as any other function. Being a
superset of Scheme [<a href="article.html#scheme:r5rs" class="inbound">9</a>] Hop supports <tt id='tt2375'
>call/cc</tt> so it naturally supports the programming model advocated by
C. Queinnec.

However, direct support for continuations as offered by <tt id='tt2376'
>call/cc</tt> is arguably too low level.  Explicit manipulation of
continuations can make programs very hard to understand, even for
experts.  So, we think that more restricted constructions that better
fit the needs of the web programming should be studied in the spirit
of the <tt id='tt2377'
>send/suspend</tt> and <tt id='tt2378'
>send/finish</tt> functions of the
<span class="sf">CONTINUE</span> server [<a href="article.html#krishnamurthi:padl03" class="inbound">10</a>].</p><p id='paragraph2383'
>The Smalltalk based Seaside framework<a href="#footnote-footnote2382"><sup><small>2</small></sup></a>  will be another source of inspiration
for modeling and capturing the flow of control. This system decomposes
web applications into stateful components. This successfully eliminates,
from the source code, the burden of explicit continuations management.</p><p id='paragraph2385'
>Code mobility is a field that we are investigating. We are
envisioning mobile code from server to client and vice versa. We are
also considering mobility intra servers. In this approach, we could
imagine spawning roaming agents processing remote data and carrying
minimal sets of information. We could also imagine implementing load
balancing of servers with mobility. Precisely, we are planning to
adapt the technics developed by S. Epardaud [<a href="article.html#epardaud:sfp04" class="inbound">3</a>] and Germain <em id='emph2384'
>et al.</em> [<a href="article.html#gmf:lispecoop05" class="inbound">5</a>] to Hop. In this context, the ideas of Obliq 
[<a href="article.html#cardelli:obliq" class="inbound">2</a>] or the technical solutions
delivered by the ACUTE experiment [<a href="article.html#sewell:icfp05" class="inbound">14</a>] are
likely to be useful.</p></div>
</div>
</div><br>
</div>
<div class="section" id="Conclusion"><!-- Conclusion -->
<a name="Conclusion"></a>
<div class="section-atitle"><h3><font color="black">8 Conclusion</font>
</h3></div><div class="section">
<p id='paragraph2387'
>Hop is a new computer language designed for programming web
applications.  It relies on two strata. The first one is used for
programming the <em id='emph2386'
>server</em> side and for constructing graphical
user interfaces. The second one is used for programming the animations
of these interfaces and the interactions with users. The paper
presents several examples of Hop programs. In particular, it shows
the programming of a simplified IMAP client. This fifty lines long
program displays interactively the messages stored on an IMAP
server.</p><p id='paragraph2390'
>Hop abstracts many operations required by the web. So, for
users not reluctant to functional programming, it makes the
programming of these applications easier than most of the other
languages we are aware of.  Its main strengths are its ability to
package a whole web application in a single bundle (e.g. a single
file), its support for functions whose calls traverse the web, and its
event notification mechanism. To our knowledge, Hop is one of the very
first languages to propose a <em id='emph2388'
>global</em> solution to the web
programming.  Hop is one of the first language to support server
<em id='emph2389'
>and</em> client programming, to manage communications initiated
from both sides, and to support HTML authoring.</p></div><br>
</div>
<div class="section" id="References"><!-- References -->
<a name="References"></a>
<div class="section-atitle"><h3><font color="black">9 References</font>
</h3></div><div class="section">


<font size="-1"><table><tbody>
<tr><td id="bmss:jcn99" align="right" valign="top"><a name="bmss:jcn99">[1]</a></td><td id="bmss:jcn99" align="left" valign="top">Braband, C. and Møller, Sandholm, A. and Schwartzbach M.I. -- <strong id='bold3493'
>A runtime system for interactive Web services</strong> -- Journal of Computer Networks, 1999.</td></tr>
<tr><td id="cardelli:obliq" align="right" valign="top"><a name="cardelli:obliq">[2]</a></td><td id="cardelli:obliq" align="left" valign="top">Cardelli, L. -- <strong id='bold3494'
>Obliq A Language with Distributed Scope</strong> -- 122, Digital Equipment Corporation, Systems Research, Palo Alto, CA, 1994.</td></tr>
<tr><td id="epardaud:sfp04" align="right" valign="top"><a name="epardaud:sfp04">[3]</a></td><td id="epardaud:sfp04" align="left" valign="top">Epardaud, S. -- <a href="http://www.inria.fr/mimosa/Stephane.Epardaud" class="http"><strong id='bold3495'
>Mobile Reactive Programming in ULM</strong></a> -- Utah, USA, Sep, 2004.</td></tr>
<tr><td id="rfc:http" align="right" valign="top"><a name="rfc:http">[4]</a></td><td id="rfc:http" align="left" valign="top">Fielding, R. et al. -- <a href="http://www.faqs.org/rfcs/rfc2616.html" class="http"><strong id='bold3496'
>Hypertext Transfer Protocol</strong></a> -- RFC 2616, The Internet Society, , 1999.</td></tr>
<tr><td id="gmf:lispecoop05" align="right" valign="top"><a name="gmf:lispecoop05">[5]</a></td><td id="gmf:lispecoop05" align="left" valign="top">Germain, G. and Monnier, S. and Feeley, M. -- <a href="http://lisp-ecoop05.bknr.net/submission/19654" class="http"><strong id='bold3497'
>Termite: a Lisp for Distributed Computing</strong></a> -- 2nd European LISP and Scheme Workshop, Glasgow, UK, , 2005.</td></tr>
<tr><td id="gfkf:ase04" align="right" valign="top"><a name="gfkf:ase04">[6]</a></td><td id="gfkf:ase04" align="left" valign="top">Graunke, P. and Findler, R. and Krishnamurthi, S. and Felleisen, M. -- <a href="citeseer.ist.psu.edu/graunke01automatically.html"><strong id='bold3498'
>Automatically restructuring programs for the Web</strong></a> -- 2004.</td></tr>
<tr><td id="gfkf:esop2003" align="right" valign="top"><a name="gfkf:esop2003">[7]</a></td><td id="gfkf:esop2003" align="left" valign="top">Graunke, P. and Findler, R.B., and Krishnamurthi, S. and Felleisen, M. -- <a href="http://www.cs.brown.edu/ sk/Publications/Papers/Published/gfkf-modeling-web-inter/" class="http"><strong id='bold3499'
>Modeling Web Interactions</strong></a> -- European Symposium on Programming, Poland, 2003.</td></tr>
<tr><td id="hanus:padl01" align="right" valign="top"><a name="hanus:padl01">[8]</a></td><td id="hanus:padl01" align="left" valign="top">Hanus, M. -- <strong id='bold3500'
>High-level server side Web scripting in Curry</strong> -- Practical Aspects of Declarative Languages, Las Vegas, NV, USA, 2001.</td></tr>
<tr><td id="scheme:r5rs" align="right" valign="top"><a name="scheme:r5rs">[9]</a></td><td id="scheme:r5rs" align="left" valign="top">Kelsey, R. and Clinger, W. and Rees, J. -- <a href="http://www.inria.fr/mimosa/fp/Bigloo/doc/r5rs.html" class="http"><strong id='bold3501'
>The Revised(5) Report on the Algorithmic Language Scheme</strong></a> -- Higher-Order and Symbolic Computation, 11(1), Sep, 1998.</td></tr>
<tr><td id="krishnamurthi:padl03" align="right" valign="top"><a name="krishnamurthi:padl03">[10]</a></td><td id="krishnamurthi:padl03" align="left" valign="top">Krishnamurthi, S. -- <strong id='bold3502'
>The CONTINUE Server (or, How I Administered PADL 2002 and 2003).</strong> -- Practical Aspects of Declarative Languages, New Orleans, LA, USA, Jan, 2003, pp. 2--16.</td></tr>
<tr><td id="meijer:jfp00" align="right" valign="top"><a name="meijer:jfp00">[11]</a></td><td id="meijer:jfp00" align="left" valign="top">Meijer, E. -- <strong id='bold3503'
>Server-Side web scripting in Haskell</strong> -- Journal of Functional Programming, 10(1), 2000.</td></tr>
<tr><td id="queinnec:icfp00" align="right" valign="top"><a name="queinnec:icfp00">[12]</a></td><td id="queinnec:icfp00" align="left" valign="top">Queinnec, C. -- <strong id='bold3504'
>The influence of browsers on evaluators</strong> -- Int'l Conf. on Functional Programming, Montréal, Canada, Sep, 2000, pp. 23--33.</td></tr>
<tr><td id="ss:popl00" align="right" valign="top"><a name="ss:popl00">[13]</a></td><td id="ss:popl00" align="left" valign="top">Sandholm, A. and Schwartzbach, M.I -- <strong id='bold3505'
>A type system for dynamic Web documents</strong> -- Boston, MA, USA, Jan, 2000, pp. 290--301.</td></tr>
<tr><td id="sewell:icfp05" align="right" valign="top"><a name="sewell:icfp05">[14]</a></td><td id="sewell:icfp05" align="left" valign="top">Sewell, P. et al. -- <strong id='bold3506'
>Acute: High-level programming language design for distributed computation</strong> -- Int'l Conf. on Functional Programming, Tallinn, Estonia, Sep, 2005.</td></tr>
<tr><td id="w3c:css2" align="right" valign="top"><a name="w3c:css2">[15]</a></td><td id="w3c:css2" align="left" valign="top">World Wide Web Consortium -- <a href="http://www.w3.org/TR/CSS2/" class="http"><strong id='bold3507'
>Cascading Style Sheets, level 2 CSS2 Specification</strong></a> -- REC-CSS2-19980512, W3C Recommendation, May, 1998.</td></tr>
</tbody></table>
</font></div><br>
</div>
<div class="section" id="Appendix"><!-- Appendix -->
<a name="Appendix"></a>
<div class="section-atitle"><h3><font color="black">Appendix</font>
</h3></div><div class="section">
<p id='paragraph2392'
>This appendix presents the syntax of Hop in EBNF
form:</p><p id='paragraph2393'
></p><DIV class='prog-border'><pre class="syntax" id='prog2406'
><em id='it3509'
><font color="#1919af">&lt;comment&gt;</font></em> &#8594; <font color="red"><strong id='bold3510'
>;</strong></font> <em id='it3512'
>&lt;all subsequent characters up to a line break&gt;</em>

<em id='it3514'
><font color="#1919af">&lt;expression&gt;</font></em> &#8594; <em id='it3516'
><font color="#1919af">&lt;main-expression&gt;</font></em>

<em id='it3518'
><font color="#1919af">&lt;main-expression&gt;</font></em> &#8594; <em id='it3520'
><font color="#1919af">&lt;simple-expression&gt;</font></em>
  | <font color="red"><strong id='bold3521'
>~</strong></font> <em id='it3524'
><font color="#1919af">&lt;gui-expression&gt;</font></em>

<em id='it3526'
><font color="#1919af">&lt;gui-expression&gt;</font></em> &#8594; <em id='it3528'
><font color="#1919af">&lt;simple-expression&gt;</font></em>
  | <font color="red"><strong id='bold3529'
>$</strong></font> <em id='it3532'
><font color="#1919af">&lt;main-expression&gt;</font></em>

<em id='it3534'
><font color="#1919af">&lt;simple-expression&gt;</font></em> &#8594; <em id='it3536'
><font color="#1919af">&lt;literal&gt;</font></em>
  | <em id='it3538'
><font color="#1919af">&lt;identifier&gt;</font></em>
  | <em id='it3540'
><font color="#1919af">&lt;attribute&gt;</font></em>
  | <font color="red"><strong id='bold3541'
>(</strong></font><em id='it3544'
><font color="#1919af">&lt;expression&gt;</font></em> <em id='it3546'
><font color="#1919af">&lt;expression&gt;</font></em><sup id='sup2395'
><font size="-2">*</font></sup><font color="red"><strong id='bold3547'
>)</strong></font>

<em id='it3550'
><font color="#1919af">&lt;identifier&gt;</font></em> &#8594; <em id='it3552'
><font color="#1919af">&lt;initial&gt;</font></em> <font color="red"><strong id='bold3553'
>{</strong></font> <em id='it3556'
><font color="#1919af">&lt;letter&gt;</font></em> | <em id='it3558'
><font color="#1919af">&lt;digit&gt;</font></em> | <em id='it3560'
><font color="#1919af">&lt;special&gt;</font></em> <font color="red"><strong id='bold3561'
>}</strong></font>
<em id='it3564'
><font color="#1919af">&lt;initial&gt;</font></em> &#8594; <em id='it3566'
><font color="#1919af">&lt;letter&gt;</font></em> | <em id='it3568'
><font color="#1919af">&lt;special&gt;</font></em>
<em id='it3570'
><font color="#1919af">&lt;letter&gt;</font></em> &#8594; <font color="red"><strong id='bold3571'
>a</strong></font> | <font color="red"><strong id='bold3573'
>b</strong></font> | ... | <font color="red"><strong id='bold3575'
>z</strong></font> | <font color="red"><strong id='bold3577'
>A</strong></font> | <font color="red"><strong id='bold3579'
>B</strong></font> | ... | <font color="red"><strong id='bold3581'
>Z</strong></font>
<em id='it3584'
><font color="#1919af">&lt;digit&gt;</font></em> &#8594; <font color="red"><strong id='bold3585'
>0</strong></font> | <font color="red"><strong id='bold3587'
>1</strong></font> | ... | <font color="red"><strong id='bold3589'
>9</strong></font>
<em id='it3592'
><font color="#1919af">&lt;special&gt;</font></em> &#8594;  <font color="red"><strong id='bold3593'
>_</strong></font> | <font color="red"><strong id='bold3595'
>+</strong></font> | <font color="red"><strong id='bold3597'
>-</strong></font> | <font color="red"><strong id='bold3599'
>/</strong></font> | <font color="red"><strong id='bold3601'
>*</strong></font> | <font color="red"><strong id='bold3603'
>?</strong></font> | <font color="red"><strong id='bold3605'
>&gt;</strong></font> | <font color="red"><strong id='bold3607'
>&lt;</strong></font> | <font color="red"><strong id='bold3609'
>=</strong></font> | <font color="red"><strong id='bold3611'
>!</strong></font> | <font color="red"><strong id='bold3613'
>%</strong></font> 
  | <font color="red"><strong id='bold3615'
>~</strong></font> | <font color="red"><strong id='bold3617'
>&#x40;</strong></font> | <font color="red"><strong id='bold3619'
>^</strong></font> | <font color="red"><strong id='bold3621'
>&amp;</strong></font> | <font color="red"><strong id='bold3623'
>\</strong></font>

<em id='it3626'
><font color="#1919af">&lt;attribute&gt;</font></em> &#8594; <font color="red"><strong id='bold3627'
>:</strong></font> <em id='it3630'
><font color="#1919af">&lt;identifier&gt;</font></em>

<em id='it3632'
><font color="#1919af">&lt;literal&gt;</font></em> &#8594; <em id='it3634'
><font color="#1919af">&lt;number&gt;</font></em>
  | <em id='it3636'
><font color="#1919af">&lt;character&gt;</font></em>
  | <em id='it3638'
><font color="#1919af">&lt;string&gt;</font></em>
  | <em id='it3640'
><font color="#1919af">&lt;boolean&gt;</font></em>

<em id='it3642'
><font color="#1919af">&lt;number&gt;</font></em> &#8594; <em id='it3644'
><font color="#1919af">&lt;digit&gt;</font></em><sup id='sup2397'
><font size="-2">+</font></sup>
  | <em id='it3646'
><font color="#1919af">&lt;digit&gt;</font></em><sup id='sup2399'
><font size="-2">+</font></sup> <font color="red"><strong id='bold3647'
>.</strong></font> <em id='it3650'
><font color="#1919af">&lt;digit&gt;</font></em><sup id='sup2401'
><font size="-2">*</font></sup>
  | <font color="red"><strong id='bold3651'
>.</strong></font> <em id='it3654'
><font color="#1919af">&lt;digit&gt;</font></em><sup id='sup2403'
><font size="-2">+</font></sup>

<em id='it3656'
><font color="#1919af">&lt;character&gt;</font></em> &#8594; <font color="red"><strong id='bold3657'
>#</strong></font><font color="red"><strong id='bold3659'
>\</strong></font> <em id='it3661'
>&lt;any character&gt;</em>

<em id='it3663'
><font color="#1919af">&lt;string&gt;</font></em> &#8594; <font color="red"><strong id='bold3664'
>&quot;</strong></font> <em id='it3667'
><font color="#1919af">&lt;string-element&gt;</font></em><sup id='sup2405'
><font size="-2">*</font></sup> <font color="red"><strong id='bold3668'
>&quot;</strong></font>
<em id='it3671'
><font color="#1919af">&lt;string-element&gt;</font></em> &#8594; <em id='it3672'
>&lt;any character other than &quot; or \&gt;</em>
  | <font color="red"><strong id='bold3673'
>\</strong></font><font color="red"><strong id='bold3675'
>&quot;</strong></font> | <font color="red"><strong id='bold3677'
>\</strong></font><font color="red"><strong id='bold3679'
>\</strong></font>
<em id='it3682'
><font color="#1919af">&lt;boolean&gt;</font></em> &#8594; <font color="red"><strong id='bold3683'
>#t</strong></font> | <font color="red"><strong id='bold3685'
>#f</strong></font>
</pre>
</DIV></div><br>
</div>
<div class="footnotes" id="Hop-a-Language-for-Programming-the-Web-2.0-footnote"><div class="footnote"><br><br>
<hr width='20%' size='2' align='left'>
<a name="footnote-footnote2346"><sup><small>1</small></sup></a>: <a href="http://homepages.inf.ed.ac.uk/wadler/links"><tt id='tt2345'
>http://homepages.inf.ed.ac.uk/wadler/links</tt></a>.
<br>
<a name="footnote-footnote2382"><sup><small>2</small></sup></a>: <a href="http://www.seaside.st"><tt id='tt2381'
>http://www.seaside.st</tt></a>.
<br>
<div></div>
</div>
<div class="skribe-ending">
<hr> 
<p class="ending" id='paragraph3692'
><font size="-1">
This <span class="sc">Html</span> page has been produced by 
<a href="http://www.inria.fr/mimosa/fp/Skribe" class="http">Skribe</a>.
<br/>
Last update <em id='it3690'
>Wed Aug 30 09:16:40 2006</em>.</font></p></div>
</body>
</html>