// -*- Mode: typescript -*-
/*=====================================================================*/
/*    serrano/prgm/project/hop/hop/node_modules/hop/config.mjs.in      */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Wed Jan 31 13:57:37 2024                          */
/*    Last change :  Thu May 16 12:01:07 2024 (serrano)                */
/*    Copyright   :  2024 Manuel Serrano                               */
/*    -------------------------------------------------------------    */
/*    Default configuration                                            */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    import                                                           */
/*---------------------------------------------------------------------*/
import { createRequire } from "node:module";
import { existsSync, readFileSync } from "node:fs";
import * as path from  "node:path";
import * as os from "node:os";
//import minimist from "../../../minimist/index.js";

export { init };

/*---------------------------------------------------------------------*/
/*    Dynamique require                                                */
/*---------------------------------------------------------------------*/
const require = createRequire(import.meta.url);

/*---------------------------------------------------------------------*/
/*    defaultConfig ...                                                */
/*---------------------------------------------------------------------*/
const defaultConfig = {
   version: "@VERSION@",
   buildid: "@BUILDTAG@",
   motd: false,
   hostname: os.hostname(),
   engine: process.features?.hop ? "hop" : "node",
   ports: { http: 0, https: -1 },
   listenAddress: false,
   soMaxConn: 16,
   maxThread: 20,
   //server: { http: -1, https: -1 },
   configDirectory: path.join(process.env.HOME, ".config", "hop"),
   cacheDirectory: path.join(process.env.HOME, ".config", "hop", "cache"),
   usersdb: undefined,
   verbose: 1,
   debug: 0,
   charset: "utf8",
   security: {
      "realm": "hop",
      "serviceAuthentication": true,
      "staticRandomization": true
   },
   credentials: {
      "key": path.join(process.cwd(), "key.pem"),
      "cert": path.join(process.cwd(), "key.pem")
   }
}

/*---------------------------------------------------------------------*/
/*    expandShellEnvVar ...                                            */
/*---------------------------------------------------------------------*/
function expandShellEnvVar(v) {
   if (typeof v === "string") {
      const m = v.match(/[$]([_a-zA-Z][_a-zA-Z0-9]*)/g);

      if (m) {
	 m.forEach(s => v = v.replace(s, process.env[s.substring(1)] || ""));
      }

      if (v.match(/^(~)\//g)) {
	 v = process.env.HOME + v.substring(1);
      }
      
      return v;
   } else {
      return v;
   }
}

/*---------------------------------------------------------------------*/
/*    loadConfig ...                                                   */
/*    -------------------------------------------------------------    */
/*    The performance of this function is not critical.                */
/*---------------------------------------------------------------------*/
function loadConfig(config, file) {
   
   
   function warning(k, cfg) {
      console.error(`warning: ignoring unknown configuration property "${k}=${cfg[k]}"`);
   }

   if (existsSync(file)) {
      try {
	 const cfg = JSON.parse(readFileSync(file, "utf8"));

	 // don't use Object.assign because loadConfig is only
	 // allowed to set properties, not to create new ones
	 for (let k in cfg) {
	    switch (k) {
	       case "//":
	       case "__":
	       case "":
		  break;

	       case "include":
		  cfg.include.forEach(f => {
		     loadConfig(config, path.join(path.dirname(file), expandShellEnvVar(f)));
		  });
		  break;

	       case "security":
		  for (let k in cfg.security) {
		     if (k in config.security) {
			config.security[k] = expandShellEnvVar(cfg.security[k]);
		     } else {
			warning(k, cfg);
		     }
		  }
		  break;

	       case "ports":
		  for (let k in cfg.ports) {
		     if (k in config.ports) {
			config.ports[k] = expandShellEnvVar(cfg.ports[k]);
		     } else {
			warning(k, cfg);
		     }
		  }
		  break;

	       case "motd":
		  config.motd = cfg.motd;
		  break;

	       case "usersdb":
		  config.usersdb = cfg.usersdb;
		  break;

	       default:
		  if (k in config) {
		     config[k] = expandShellEnvVar(cfg[k]);
		  } else {
		     warning(k, cfg);
		  }
	    }
	 }
      } catch (e) {
	 throw e;
      }
   }
}

/*---------------------------------------------------------------------*/
/*    loadConfigDir ...                                                */
/*---------------------------------------------------------------------*/
function loadConfigDir(config, dir) {
   const port = config.ports.http;
   const engine = config.engine;

   // base config file
   loadConfig(config, path.join(dir, "config.json"));

   // engine-base config file
   loadConfig(config, path.join(dir, `config.${engine}.json`));

   // per-engine config file 
   loadConfig(config, path.join(dir, `config.${port}.json`));
}

/*---------------------------------------------------------------------*/
/*    loadUsersDB ...                                                  */
/*---------------------------------------------------------------------*/
function loadUsersDB(config, descr) {
   if (descr.match(/\.json$/)) {
      config.users = JSON.parse(readFileSync(expandShellEnvVar(descr), "utf8"));
   } else if (descr.match(/^data:text\/json,/)) {
      config.users = JSON.parse(descr.substring("data:text/json,".length));
   }
}

/*---------------------------------------------------------------------*/
/*    resolveDirectories ...                                           */
/*---------------------------------------------------------------------*/
function resolveDirectories(directories) {
   if (directories === "*") {
      return "*";
   } else {
      return directories.map(dir => require.resolve(dir));
   }
}

/*---------------------------------------------------------------------*/
/*    init ...                                                         */
/*---------------------------------------------------------------------*/
function init(cfg) {
   const config = {};
   
   // default configuration
   Object.assign(config, defaultConfig);
   Object.assign(config, cfg);
   
   // config file
   if (config.configDirectory) {
      loadConfigDir(config, config.configDirectory);
      loadConfigDir(config, path.join(config.configDirectory, config.hostname));
   }

   // reassign the user configuration
   Object.assign(config, cfg);
   
   // users
   if (config.users) {
      // deep copy of the users db if pre-configured
      config.users = config.users.map(u => Object.assign({}, u))
   } else {
      if (config.usersdb) {
	 loadUsersDB(config, config.usersdb);
      } else if (config.configDirectory) {
	 // load default users
	 const file = (config.configDirectory + "/users.json");
	 if (existsSync(file)) {
	    loadUsersDB(config, file);
	 } else {
	    config.users = [];
	 }
      } else {
	 config.users = [];
      }
   }
   if (config.users.length === 0 && config.verbose >= 1) {
      console.error("warning, no users registered!");
   }
   
   // freeze the configuration
   Object.freeze(config.ports);
   Object.freeze(config.security);
   Object.freeze(config.users);
   config.users.forEach(u => {
      Object.freeze(u.services);
      Object.freeze(resolveDirectories(u.directories));
      Object.freeze(u)
   });
   
   Object.freeze(config);
   
   return config;
}

/* {*---------------------------------------------------------------------*} */
/* {*    parseCommandLine ...                                             *} */
/* {*---------------------------------------------------------------------*} */
/* function parseCommandLine(argv) {                                   */
/*                                                                     */
/*    function help() {                                                */
/*       console.log("Usage: hop [options] ...");                      */
/*       console.log("");                                              */
/*       console.log("Options:");                                      */
/*       console.log("  -h|--help              This message.");        */
/*       console.log("  --version              Display version.");     */
/*       console.log("  -p|--http-port PORT    HTTP port number.");    */
/*       console.log("  -s|--https-port PORT   HTTPS port number.");   */
/*       console.log("  -q                     Do not load any config file."); */
/*       console.log("  -vLevel                Verbosity level.");     */
/*       console.log("  -gLevel                Debug level.");         */
/*       console.log("  --config FILE          Load an alternate config file."); */
/*       console.log("  --config-directory DIR Set config directory."); */
/*       console.log("  --cache-directory DIR  Set cache directory."); */
/*       console.log("  --usersdb FILE         Set user database name."); */
/*       console.log("");                                              */
/*       console.log("Default configuration:");                        */
/*       console.log(`  - v: ${defaultConfig.verbose}`);               */
/*       console.log(`  - config-directory: ${defaultConfig.configDirectory}`); */
/*       console.log(`  - cache-directory: ${defaultConfig.cacheDirectory}`); */
/*       console.log(`  - http-port: ${defaultConfig.ports.http}`);    */
/*       console.log(`  - https-port: ${defaultConfig.ports.https}`);  */
/*                                                                     */
/*       process.exit(0);                                              */
/*    }                                                                */
/*                                                                     */
/*    // initialize command line configuration                         */
/*    const config = {}                                                */
/*                                                                     */
/*    // command line parsing                                          */
/*    const args = minimist(argv.slice(2), { names: ["v"] });          */
/*                                                                     */
/*    // help                                                          */
/*    if (args.h || args.help) {                                       */
/*       help();                                                       */
/*    }                                                                */
/*                                                                     */
/*    // version                                                       */
/*    if (args.version) {                                              */
/*       console.log("Hop v" + defaultConfig.version);                 */
/*       process.exit(0);                                              */
/*    }                                                                */
/*                                                                     */
/*    if (args["config-directory"]) config.configDirectory = args["config-directory"]; */
/*    if (args["cache-directory"]) config.cacheDirectory = args["cache-directory"]; */
/*    if (args["p"] || args["http-port"]) config.ports.http = (args["p"] || args["http-port"]); */
/*    if ("v" in args) config.verbose = ~~args.v;                      */
/*    if ("g" in args) config.debug = ~~args.g;                        */
/*    if ("q" in args) config.configDirectory = false;                 */
/*                                                                     */
/*    if ("usersdb" in args) config.usersdb = args.usersdb;            */
/*                                                                     */
/*    return args;                                                     */
/* }                                                                   */
