#*=====================================================================*/
#*    serrano/prgm/project/hop/3.2.x/node_modules/Makefile             */
#*    -------------------------------------------------------------    */
#*    Author      :  Manuel Serrano                                    */
#*    Creation    :  Fri Jan 20 13:46:40 2006                          */
#*    Last change :  Tue Mar 13 08:37:18 2018 (serrano)                */
#*    Copyright   :  2006-18 Manuel Serrano                            */
#*    -------------------------------------------------------------    */
#*    node_modules Makefile                                            */
#*=====================================================================*/
do: build

#*---------------------------------------------------------------------*/
#*    Configuration                                                    */
#*---------------------------------------------------------------------*/
-include ../etc/Makefile.hopconfig
-include ../etc/Makefile.version

#*---------------------------------------------------------------------*/
#*    Population                                                       */
#*---------------------------------------------------------------------*/
POPULATION = Makefile Makefile.modules mkjsast.scm \
	hopc/package.json hopc/lib/hopc.js \
	tree/package.json tree/lib/tree.js tree/lib/_tree.hop tree/doc/tree.md \
	notepad/package.json notepad/lib/notepad.js notepad/lib/_notepad.hop \
	spage/package.json spage/lib/spage.js spage/lib/_spage.hop spage/doc/spage.md\
        fontifier/package.json fontifier/lib/fontifier.js \
        fontifier/lib/_fontifier.hop fontifier/hss/fontifier.hss \
        fontifier/lib/Makefile \
        wiki/package.json wiki/lib/wiki.js wiki/lib/_wiki.hop \
        security/package.json security/lib/security.js security/lib/_security.hop \
        config/package.json config/lib/config.js config/lib/_config.hop \
        config/lib/Makefile config/doc/config.md \
        user/package.json user/lib/user.js user/lib/_user.hop user/doc/user.md \
        hss/package.json hss/lib/hss.js hss/lib/_hss.hop hss/doc/hss.md \
        hopdoc/package.json hopdoc/lib/hopdoc.js hopdoc/lib/_hopdoc.hop \
        hopdoc/lib/xml-ignore.json \
        markdown/package.json markdown/lib/markdown.js \
        markdown/lib/_markdown.hop markdown/lib/md.hop markdown/hss/markdown.hss \
        markdown/lib/token.sch markdown/doc/markdown.md markdown/lib/Makefile \
        syslog/package.json syslog/lib/syslog.js syslog/lib/_syslog.hop \
        syslog/lib/Makefile syslog/doc/syslog.md \
        systime/package.json systime/lib/systime.js systime/lib/_systime.hop \
        systime/lib/Makefile systime/doc/systime.md \
        cpp/package.json cpp/lib/Makefile cpp/lib/cpp.js cpp/lib/cpp.json \
        cpp/doc/cpp.md

#*---------------------------------------------------------------------*/
#*    The entries                                                      */
#*---------------------------------------------------------------------*/
.PHONY: build clean install uninstall

build: hopc/lib/walk.js hopc/lib/ast.js
	$(MAKE) -C markdown/lib build
	$(MAKE) -C fontifier/lib build
	$(MAKE) -C config/lib build
	$(MAKE) -C syslog/lib build
	$(MAKE) -C systime/lib build
	$(MAKE) -C cpp/lib build

#*---------------------------------------------------------------------*/
#*    install                                                          */
#*---------------------------------------------------------------------*/
install:
	$(MAKE) mkdir DIR=$(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/hopc $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/tree $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/notepad $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/spage $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/wiki $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/security $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/config $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/user $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/hopdoc $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	cp -r ../node_modules/hss $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	chmod -R $(MODDIR) $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules
	$(MAKE) -C markdown/lib install
	$(MAKE) -C fontifier/lib install
	$(MAKE) -C config/lib install
	$(MAKE) -C syslog/lib install
	$(MAKE) -C systime/lib install
	$(MAKE) -C cpp/lib install

uninstall:
	-$(RM) -rf $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules

#*---------------------------------------------------------------------*/
#*    walk.js ...                                                      */
#*---------------------------------------------------------------------*/
hopc/lib/walk.js: ../js2scheme/ast.scm
	date +'/* generated file, do not edit (%d %B %Y) */' > $@
	echo "" >> $@
	echo "var ast = require( './ast.js' );" >> $@
	echo "" >> $@
	echo "" >> $@
	(cd $(BUILDDIR)/js2scheme; $(BIGLOO) -srfi generate-javascript-walker -expand -o /dev/null ../js2scheme/ast.scm) >> $@

#*---------------------------------------------------------------------*/
#*    ast.js                                                           */
#*---------------------------------------------------------------------*/
hopc/lib/ast.js: ../js2scheme/ast.scm mkjsast.scm
	date +'/* generated file, do not edit (%d %B %Y) */' > $@
	echo "" >> $@
	$(BIGLOO) -i mkjsast.scm ../js2scheme/ast >> $@

#*---------------------------------------------------------------------*/
#*    clean                                                            */
#*---------------------------------------------------------------------*/
clean:
	$(RM) -f hopc/lib/walk.js
	$(RM) -f hopc/lib/ast.js
	$(MAKE) -C markdown/lib clean
	$(MAKE) -C fontifier/lib clean
	$(MAKE) -C config/lib clean
	$(MAKE) -C syslog/lib clean
	$(MAKE) -C systime/lib clean
	$(MAKE) -C cpp/lib clean

devclean: clean

distclean: clean

