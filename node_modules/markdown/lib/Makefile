#*=====================================================================*/
#*    .../project/hop/3.0.x/node_modules/markdown/lib/Makefile         */
#*    -------------------------------------------------------------    */
#*    Author      :  Manuel Serrano                                    */
#*    Creation    :  Fri Aug 28 10:00:50 2015                          */
#*    Last change :  Tue Sep  1 11:07:00 2015 (serrano)                */
#*    Copyright   :  2015 Manuel Serrano                               */
#*    -------------------------------------------------------------    */
#*    markdown precompilation                                          */
#*=====================================================================*/
do: build

#*---------------------------------------------------------------------*/
#*    Configuration                                                    */
#*---------------------------------------------------------------------*/
-include ../../../etc/Makefile.hopconfig
-include ../../../etc/Makefile.version
-include $(BIGLOOLIBDIR)/Makefile.config
-include $(BIGLOOLIBDIR)/Makefile.misc

HOPCLOSELIBS_U=$(BGLCLOSELIBS_U) \
  -ljs2scheme_u-$(HOPRELEASE) -lhopscript_u-$(HOPRELEASE) \
  -lhop_u-$(HOPRELEASE) -lhopscheme_s-$(HOPRELEASE) \
  -lnodejs_u-$(HOPRELEASE) -lhopwidget_u-$(HOPRELEASE)
RPATH=$(BIGLOOLIBDIR) $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)

DIR=node_modules/$(PACKAGE)/lib
LIBSDIR=hop/$(HOPRELEASE)/$(DIR)/.libs/$(HOPRELEASE)/$(MACH)

PACKAGE=markdown

#*---------------------------------------------------------------------*/
#*    The entries                                                      */
#*---------------------------------------------------------------------*/
.PHONY: build install uninstall markdown _markdown

build: .afile o
	$(MAKE) o/markdown_u-$(HOPRELEASE).$(SHAREDSUFFIX) \
            TARGETNAME=markdown \
            OBJECTS=o/markdown.o
	$(MAKE) o/_markdown_u-$(HOPRELEASE).$(SHAREDSUFFIX) \
            TARGETNAME=_markdown \
            OBJECTS="o/_markdown.o o/md.o"

install:
	$(MAKE) mkdir DIR=$(DESTDIR)$(HOPLIBDIR)/$(LIBSDIR)
	$(MAKE) install-module TARGETNAME=_markdown
	$(MAKE) install-module TARGETNAME=markdown

install-module:
	$(MAKE) install-shared-lib \
                INSTALL="$(INSTALL)" \
                BOOTLIBDIR=$(BUILDDIR)/$(DIR)/o \
                FILDIR=$(LIBSDIR) \
                LIBDIR=$(DESTDIR)$(HOPLIBDIR) \
                LIB=$(TARGETNAME)_u-$(HOPRELEASE)
	chmod -R $(MODDIR) $(DESTDIR)$(HOPLIBDIR)/hop/$(HOPRELEASE)/$(DIR)
	chmod $(MODEXE) $(DESTDIR)$(HOPLIBDIR)/$(LIBSDIR)/$(TARGETNAME)_u-$(HOPRELEASE).$(SHAREDSUFFIX)

uninstall:
	$(MAKE) uninstall-module TARGETNAME=_markdown
	$(MAKE) uninstall-module TARGETNAME=markdown

uninstall-module:
	$(MAKE) uninstall-shared-lib LIB=$(TARGETNAME)_u-$(HOPRELEASE).$(SHAREDSUFFIX)

#*---------------------------------------------------------------------*/
#*    lib                                                              */
#*---------------------------------------------------------------------*/
o:
	mkdir o

markdown: o
	$(MAKE) o/$(TARGETNAME)_u-$(HOPRELEASE).$(SHAREDSUFFIX)

_markdown: o
	$(MAKE) o/$(TARGETNAME)_u-$(HOPRELEASE).$(SHAREDSUFFIX)

o/$(TARGETNAME)_u-$(HOPRELEASE).$(SHAREDSUFFIX): $(OBJECTS)
	$(MAKE) shared-lib \
             LDINSTALLNAMEDIR=$(DESTDIR)$(HOPLIBDIR)/$(LIBSDIR) \
             BOOTLIBDIR=$(BUILDDIR)/$(DIR)/o \
             FORCELD=true \
             LIBDEST=$@ \
             SONAME=$(TARGETNAME)_u-$(HOPRELEASE).$(SHAREDSUFFIX) \
             LDOPTS="-L$(BUILDLIBDIR) $(LDOPTS)" \
             CLOSELIBS="-lbigloo_u-$(RELEASE) $(HOPCLOSELIBS_U)"

#*---------------------------------------------------------------------*/
#*    .afile                                                           */
#*---------------------------------------------------------------------*/
.afile: _markdown.hop md.hop
	(cd $(dir $@) && $(AFILE) -suffix hop $(notdir $^) -o $(notdir $@))

#*---------------------------------------------------------------------*/
#*    clean                                                            */
#*---------------------------------------------------------------------*/
clean:
	$(RM) -rf o

devclean:
	$(RM) -f .afile

distclean: devclean

#*---------------------------------------------------------------------*/
#*    Suffixes                                                         */
#*---------------------------------------------------------------------*/
.SUFFIXES:
.SUFFIXES: .scm .o .hop .js

#*---------------------------------------------------------------------*/
#*    explicit rules                                                   */
#*---------------------------------------------------------------------*/
o/_markdown.o: _markdown.hop
	@ $(call compile3,$(HOPC),$(HFLAGS),$(BCFLAGS) -dload-sym,$(BLFLAGS),-c,$< -o $@)

#*---------------------------------------------------------------------*/
#*    The implicit rules                                               */
#*---------------------------------------------------------------------*/
o/%.o: %.scm
	@ $(call compile2,$(BIGLOO),$(BCFLAGS),$(BLFLAGS),-c,$< -o $@)

o/%.o: %.hop
	@ $(call compile3,$(HOPC),$(HFLAGS),$(BCFLAGS),$(BLFLAGS),-c,$< -o $@)

%.scm: %.hop
	@ $(call compile3,$(HOPC),$(HFLAGS),$(BCFLAGS),$(BLFLAGS),-s,$< -o $@)

o/%.o: %.js
	@ $(call compile3,$(HOPC),$(HFLAGS),$(BCFLAGS) -dload-sym,$(BLFLAGS),$(BHOPCFLAGS) -c --no-js-module-main --js-module-name __nodejs_$* --js-module-path $*,$< -o $@)

