;*=====================================================================*/
;*    .../hop/3.0.x/node_modules/security/lib/_security.hop            */
;*    -------------------------------------------------------------    */
;*    Author      :  Manuel Serrano                                    */
;*    Creation    :  Fri Jun 19 13:21:01 2015                          */
;*    Last change :  Fri Jun 19 16:51:54 2015 (serrano)                */
;*    Copyright   :  2015 Manuel Serrano                               */
;*    -------------------------------------------------------------    */
;*    Hop security manager                                             */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module _security
   
   (library hopscript hop hopwidget nodejs)
   
   (export (hopscript ::JsGlobalObject ::JsObject ::JsObject ::JsObject)))
	   
;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*---------------------------------------------------------------------*/
(define (hopscript %this this scope module)
   (let ((exports (js-get module 'exports %this)))
      (js-bind! %this exports 'addSecurityManager
	 :value (js-make-function %this
		   (lambda (this secm)
		      (hop-security-manager-set!
			 (when (isa? secm JsObject)
			    (js-security-manager->hop secm %this))))
		   1 'addSecurityManager)
	 :writable #f
	 :enumerable #f)
      (js-bind! %this exports 'xmlAttributeSanitize
	 :value (js-make-function %this
		   (lambda (this attr id)
		      (xml-attribute-sanitize attr id))
		   2 'xmlAttributeSanitize))
      (js-bind! %this exports 'xmlTreeCompare
	 :value (js-make-function %this
		   (lambda (this node be req)
		      (xml-tree-compare node be req))
		   3 'xmlTreeCompare)
	 :writable #f
	 :enumerable #f)
      (js-bind! %this exports 'xmlStringSanitize
	 :value (js-make-function %this
		   (lambda (this str)
		      (js-string->jsstring
			 (xml-string-sanitize (js-jsstring->string str))))
		   1 'xmlStringSanitize)
	 :writable #f
	 :enumerable #f)
      exports))

;*---------------------------------------------------------------------*/
;*    js-security-manager->hop ...                                     */
;*---------------------------------------------------------------------*/
(define (js-security-manager->hop secm::JsObject %this)
   (let ((frozen (js-get secm 'isFrozen %this)))
      (if (and #f
	       (or (not (isa? frozen JsFunction))
		   (not (js-call0 %this frozen secm))))
	  (error "security-manager" "security manager should be frozen" secm)
	  (let ((name (js-get secm 'name %this))
		(xml-sanitize (js-get secm 'xmlSanitize %this))
		(string-sanitize (js-get secm 'stringSanitize %this))
		(inl-sanitize (js-get secm 'inlineSanitize %this))
		(script-sanitize (js-get secm 'scriptSanitize %this))
		(attr-sanitize (js-get secm 'attributeSanitize %this))
		(runtime (js-get secm 'runtime %this)))
	     (instantiate::security-manager
		(name (if (isa? name JsStringLiteral)
			  (js-jsstring->string name)
			  "security manager"))
		(xml-sanitize (if (isa? xml-sanitize JsFunction)
				  (lambda (node be req)
				     (js-worker-exec (js-current-worker)
					"security manager xmlSanitizer"
					(lambda ()
					   (js-call3 %this xml-sanitize secm node be req))))
				  (lambda (node be req) node)))
		(string-sanitize (if (isa? string-sanitize JsFunction)
				     (lambda (str)
					(js-jsstring->string
					   (js-call1 %this string-sanitize secm
					      (js-string->jsstring str)))) 
				     (lambda (str) str)))
		(inline-sanitize (if (isa? inl-sanitize JsFunction)
				     (lambda (node)
					(js-call1 %this inl-sanitize secm node))
				     (lambda (node) node)))
		(script-sanitize (if (isa? script-sanitize JsFunction)
				     (lambda (node)
					(js-call1 %this script-sanitize secm node))
				     (lambda (node) node)))
		(attribute-sanitize (if (isa? attr-sanitize JsFunction)
					(lambda (attr id)
					   (js-call2 %this script-sanitize secm attr id))
					(lambda (attr id) id)))
		(runtime (if (isa? runtime JsArray)
			     (map! (lambda (el)
				      (if (isa? el JsStringLiteral)
					  (js-jsstring->string el)
					  (error "security-manager"
					     "wrong runtime" el)))
				(jsarray->list runtime %this))
			     '())))))))
